<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="概要
EC2 インスタンスのメモリやディスクの使用率を CloudWatch からモニタしたい場合、EC2 インスタンスに CloudWatch Agent をインストールし設定してやることでメトリクスとして採取できる。この記事ではエージェントのインストールを設定についてまとめる。"><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><meta name=generator content="Hugo 0.147.7"><title>CloudWatch Agent | Memo.Namo</title><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/style/main.css></head><body><div class=flexbox><div><header id=site-header class=toplevel-container><h1><a href=/>Memo.Namo</a></h1><nav><ul class=horizontal-menu><li class=horizontal-menu-item><a href=/about/>About</a></li><li class=horizontal-menu-item><a href=/knowledge/>Knowledge</a></li></ul></nav></header><main id=site-main class=toplevel-container><article class="content-container content-grid"><header class=content-grid-header><div><a class=nav-category href=/knowledge/aws/>AWS</a><h1 class=content-grid-title>CloudWatch Agent</h1></div><p class=content-grid-desc><span>公開日: 2024-10-06</span>
<span>更新日: 2024-10-06</span></p></header><aside class=content-grid-side><div class=nav-sticky><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#1-セットアップ>1. セットアップ</a><ul><li><a href=#iamロールの作成--割当て>IAMロールの作成 & 割当て</a></li><li><a href=#エージェントをインストール>エージェントをインストール</a></li></ul></li><li><a href=#2-設定ファイルを作成>2. 設定ファイルを作成</a><ul><li><a href=#1-ウィザードで作成>1. ウィザードで作成</a></li><li><a href=#2-手動で作成>2. 手動で作成</a></li><li><a href=#3-エージェントを起動>3. エージェントを起動</a></li></ul></li><li><a href=#ssm-から制御する>SSM から制御する</a><ul><li><a href=#設定をパラメータストアへアップ>設定をパラメータストアへアップ</a></li><li><a href=#エージェントを制御>エージェントを制御</a></li></ul></li><li><a href=#使えるメトリクス>使えるメトリクス</a></li></ul></nav><nav class=nav-tag><h2>タグ</h2><ul class=tag-container><li class="tag-item tag-item-inactive"><a href=/tags/auth/>Auth</a></li><li class="tag-item tag-item-inactive"><a href=/tags/businessman/>BusinessMan</a></li><li class="tag-item tag-item-inactive"><a href=/tags/database/>Database</a></li><li class="tag-item tag-item-inactive"><a href=/tags/dataengineering/>DataEngineering</a></li><li class="tag-item tag-item-inactive"><a href=/tags/datavisualization/>DataVisualization</a></li><li class="tag-item tag-item-inactive"><a href=/tags/devops/>DevOps</a></li><li class="tag-item tag-item-inactive"><a href=/tags/iac/>IaC</a></li><li class="tag-item tag-item-active"><a href=/tags/infrastructure/>Infrastructure</a></li></ul></nav></div></aside><section class="md-content content-grid-main"><h1 id=概要>概要</h1><p>EC2 インスタンスのメモリやディスクの使用率を CloudWatch からモニタしたい場合、EC2 インスタンスに CloudWatch Agent をインストールし設定してやることでメトリクスとして採取できる。この記事ではエージェントのインストールを設定についてまとめる。</p><h1 id=1-セットアップ>1. セットアップ</h1><h2 id=iamロールの作成--割当て>IAMロールの作成 & 割当て</h2><p>EC2 インスタンスから CloudWatch へメトリクスを送信するためのロールを作成する (<a href=https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/create-iam-roles-for-cloudwatch-agent.html>参考資料</a>)。作成したら CloudWatch Agent を動かす EC2 インスタンスの IAM ロールに指定する。</p><ul><li>信頼されたエンティティタイプ: <strong>AWS のサービス</strong></li><li>ユースケース: <strong>EC2</strong></li><li>許可ポリシーから以下のポリシーをアタッチする<ul><li><strong>AmazonSSMManagedInstanceCore</strong></li><li><strong>CloudWatchAgentServerPolicy</strong></li></ul></li><li>ロール名: 適当な名前を付ける (例: sample-iamrole-instance)</li></ul><h2 id=エージェントをインストール>エージェントをインストール</h2><p>EC2 インスタンスへ SSH で入り、以下コマンドを実行しエージェントをインストールする (<a href=https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/install-CloudWatch-Agent-on-EC2-Instance.html>参考資料</a>)。ここではカスタムメトリクスも収集できるよう collectd もインストールする。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo yum install amazon-cloudwatch-agent collectd
</span></span></code></pre></div><h1 id=2-設定ファイルを作成>2. 設定ファイルを作成</h1><h2 id=1-ウィザードで作成>1. ウィザードで作成</h2><p>コンソール上で確認される事柄へ答えていくことで設定ファイルを作成できる (<a href=https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/create-cloudwatch-agent-configuration-file-wizard.html>参考資料</a>)。細かい設定は出来ないため、ウィザードで作成してから手動でカスタマイズすると良い。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard
</span></span><span class=line><span class=cl><span class=c1># ウィザードに従い設定値を入力すると設定ファイルに作成される。採取可能なメトリクスは (参考資料3) を参照。</span>
</span></span><span class=line><span class=cl><span class=c1># 途中でパラメータストアへ設定を保存するか聞かれるが、ここではローカルへ保存する。</span>
</span></span></code></pre></div><p>作成するとファイル (/opt/aws/amazon-cloudwatch-agent/bin/config.json) が作成される。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;agent&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;metrics_collection_interval&#34;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;run_as_user&#34;</span><span class=p>:</span> <span class=s2>&#34;cwagent&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metrics&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;aggregation_dimensions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;InstanceId&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;append_dimensions&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;AutoScalingGroupName&#34;</span><span class=p>:</span> <span class=s2>&#34;${aws:AutoScalingGroupName}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;ImageId&#34;</span><span class=p>:</span> <span class=s2>&#34;${aws:ImageId}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;InstanceId&#34;</span><span class=p>:</span> <span class=s2>&#34;${aws:InstanceId}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;InstanceType&#34;</span><span class=p>:</span> <span class=s2>&#34;${aws:InstanceType}&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;metrics_collected&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;collectd&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;metrics_aggregation_interval&#34;</span><span class=p>:</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;disk&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;measurement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;used_percent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;metrics_collection_interval&#34;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;resources&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mem&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;measurement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;mem_used_percent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;metrics_collection_interval&#34;</span><span class=p>:</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;statsd&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;metrics_aggregation_interval&#34;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;metrics_collection_interval&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;service_address&#34;</span><span class=p>:</span> <span class=s2>&#34;:8125&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=2-手動で作成>2. 手動で作成</h2><p>細かい設定は設定ファイルを編集する事で可能。フォーマットや設定値は (<a href=https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-Configuration-File-Details.html>参考資料</a>) を参照。なお、ウィザードで作成すると mem の measurement のメトリクスに <code>mem_</code> プレフィックスが付くが、省略しても問題無い。なぜ付くのかは不明。</p><h2 id=3-エージェントを起動>3. エージェントを起動</h2><p>(<a href=https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/install-CloudWatch-Agent-commandline-fleet.html#start-CloudWatch-Agent-EC2-commands-fleet>参考資料</a>)。フェッチするコンフィグに指定する <code>-c</code> オプションには相対パスも指定できた。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 設定をフェッチ</span>
</span></span><span class=line><span class=cl>sudo amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json
</span></span><span class=line><span class=cl><span class=c1># エージェントの状態を取得</span>
</span></span><span class=line><span class=cl>amazon-cloudwatch-agent-ctl -a status 
</span></span><span class=line><span class=cl><span class=c1># エージェントを停止</span>
</span></span><span class=line><span class=cl>sudo amazon-cloudwatch-agent-ctl -a stop
</span></span><span class=line><span class=cl><span class=c1># エージェントを起動</span>
</span></span><span class=line><span class=cl>sudo amazon-cloudwatch-agent-ctl -a start
</span></span></code></pre></div><h1 id=ssm-から制御する>SSM から制御する</h1><h2 id=設定をパラメータストアへアップ>設定をパラメータストアへアップ</h2><p>コンフィグをパラメータストアに保管して使用する事も可能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 設定ファイルをパラメータストアへアップ</span>
</span></span><span class=line><span class=cl>aws ssm put-parameter --overwrite <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --name <span class=s2>&#34;AmazonCloudWatch-linux&#34;</span> --type <span class=s2>&#34;String&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --value file:///opt/aws/amazon-cloudwatch-agent/bin/config.json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># エージェントからフェッチ</span>
</span></span><span class=line><span class=cl>sudo amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c ssm:AmazonCloudWatch-linux 
</span></span></code></pre></div><h2 id=エージェントを制御>エージェントを制御</h2><p>System Manager の Run Command を使用すると AWS マネジメントコンソールから CloudWatch Agent の設定ファイルをリロードできる。以下の設定で Run Command する。</p><ul><li>コマンドドキュメント: <strong>AmazonCloudWatch-ManageAgent</strong></li><li>コマンドのパラメータ<ul><li>Action: <strong>configure</strong></li><li>Mode: <strong>ec2</strong></li><li>Optional Configuration Source: <strong>ssm</strong></li><li>Optional Configuration Location: <strong>ssm:AmazonCloudWatch-linux</strong></li><li>Optional Restart: <strong>yes</strong></li></ul></li><li>ターゲット: (設定対象の EC2 インスタンスを指定)</li><li>出力オプション: (適当に設定)</li></ul><h1 id=使えるメトリクス>使えるメトリクス</h1><p>CloudWatch のメトリクスから見ることができる (<a href=https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/metrics-collected-by-CloudWatch-agent.html>参考資料</a>)。名前空間は既定で CWAgent が使用される。</p></section></article></main></div><div><footer id=site-footer class=toplevel-container><p>このサイトでは <a href=https://icons8.jp/>icons8</a> の素材を使用しています。</p><p>&copy; 2025 namoshika, All rights reserved</p></footer></div></div></body></html>