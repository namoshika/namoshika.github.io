<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="データのセキュリティと暗号化
データの暗号化関係は (参考資料1) 配下に資料有り。サブスクリプションの種別へ Enterprise を選択している場合には以下を KMS の暗号化対象として設定可能 (参考資料2)。"><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><meta name=generator content="Hugo 0.136.4"><title>データのセキュリティと暗号化 | Memo.Namo</title>
<meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/style/main.css></head><body><div class=flexbox><div><header id=site-header class=toplevel-container><h1><a href=/>Memo.Namo</a></h1><nav><ul class=horizontal-menu><li class=horizontal-menu-item><a href=/about/>About</a></li><li class=horizontal-menu-item><a href=/knowledge/>Knowledge</a></li></ul></nav></header><main id=site-main class=toplevel-container><article class="content-container content-grid"><header class=content-grid-header><div><a class=nav-category href=/knowledge/databricks/>Databricks</a><h1 class=content-grid-title>データのセキュリティと暗号化</h1></div><p class=content-grid-desc><span>公開日: 2024-05-07</span>
<span>更新日: 2024-05-17</span></p></header><aside class=content-grid-side><div class=nav-sticky><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#データのセキュリティと暗号化>データのセキュリティと暗号化</a></li><li><a href=#s3バケット内全てを暗号化する>S3バケット内全てを暗号化する</a></li><li><a href=#やってみる>やってみる</a></li><li><a href=#参考資料>参考資料</a></li></ul></nav><nav class=nav-tag><h2>タグ</h2><ul class=tag-container><li class="tag-item tag-item-inactive"><a href=/tags/auth/>Auth</a></li><li class="tag-item tag-item-inactive"><a href=/tags/businessman/>BusinessMan</a></li><li class="tag-item tag-item-inactive"><a href=/tags/database/>Database</a></li><li class="tag-item tag-item-inactive"><a href=/tags/dataengineering/>DataEngineering</a></li><li class="tag-item tag-item-inactive"><a href=/tags/datavisualization/>DataVisualization</a></li><li class="tag-item tag-item-inactive"><a href=/tags/devops/>DevOps</a></li><li class="tag-item tag-item-inactive"><a href=/tags/iac/>IaC</a></li><li class="tag-item tag-item-active"><a href=/tags/infrastructure/>Infrastructure</a></li></ul></nav></div></aside><section class="md-content content-grid-main"><h1 id=データのセキュリティと暗号化>データのセキュリティと暗号化</h1><p>データの暗号化関係は (参考資料1) 配下に資料有り。サブスクリプションの種別へ Enterprise を選択している場合には以下を KMS の暗号化対象として設定可能 (参考資料2)。</p><ul><li>マネージドサービス … コントロールプレーンにあるデータ (ノートブックやクエリ)</li><li>ワークスペースストレージ … ワークスペースのルートS3バケット、クラスターのEBS</li></ul><p>以下設定を行うことで暗号化する。なお、後からワークスペースへ CMK 対称キーを設定する事も可能だが、設定前に生成されたファイルが暗号化されているかは保証されない (参考資料5)。</p><ul><li>AWS KMS<ul><li>CMK 対称キーを作成</li></ul></li><li>Databricks アカウントコンソール<ul><li>暗号化キーへ CMK 対称キーを登録</li><li>ワークスペース作成時に登録した CMK 対称キーを指定</li></ul></li></ul><h1 id=s3バケット内全てを暗号化する>S3バケット内全てを暗号化する</h1><p>ワークスペースの暗号化を行っても全てのファイルは暗号化されない。</p><p>全ファイルの暗号化はバケットのデフォルト暗号化へ KMS を指定してやることで可能。その場合は Databricks のアカウントコンソールの「ストレージ設定」に登録してある IAM ロールに対して、作成した KMS の鍵を使用する権限を付与する (参考資料4)。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;kms:Decrypt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;kms:Encrypt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;kms:GenerateDataKey*&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;arn:aws:kms:&lt;KMS-KEY&gt;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>デフォルト暗号化を指定していないバケットへの読み書きを暗号化する場合、 <code>spark.read</code> や <code>spark.write</code> を使用した読み書きに対してはクラスター作成時に Spark 構成の設定値を追加してやる事で KMS キーを指定できる。 (参考資料3)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>spark.hadoop.fs.s3a.server-side-encryption.key {CMK-ARN}
</span></span><span class=line><span class=cl>spark.hadoop.fs.s3a.server-side-encryption-algorithm SSE-KMS
</span></span></code></pre></div><h1 id=やってみる>やってみる</h1><ul><li>AWS KMS で CMK を作成<ul><li>タイプ: 対称キー</li><li>使用法: 暗号化および復号化</li><li>キーマテリアルオリジン: KMS</li><li>リージョン: 単一リージョンキー</li><li>エイリアス: (分かりやすい名前)</li><li>キー管理者: (自身の IAM User)</li><li>キーユーザー: (なし)</li><li>ポリシー: Databricks アカウント管理画面から「暗号化キー設定」のキー追加を開き、表示されるポリシーをコピペ。プレースホルダー箇所 (<code>&lt;cross-account-iam-role-arn></code>) を資格情報として登録している IAM ロールのARNへ置換 (Databricks からのキー使用を許可)</li></ul></li><li>AWS IAM で Workspace S3 バケットアクセス用 IAM ロールへ権限追加<ul><li>作成した KMS CMK に対して以下操作を行うする権限を追加<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;kms:Decrypt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;kms:Encrypt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;kms:GenerateDataKey*&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;arn:aws:kms:&lt;KMS-KEY&gt;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li></ul></li><li>Databricks アカウントコンソール<ul><li>暗号化キー設定からキー追加</li><li>ワークスペース作成 (作成する際、資格情報の設定で「高度な設定」を押し、暗号化キーを指定)</li></ul></li><li>Databricks ワークスペース<ul><li>ワークスペース S3 バケットのデフォルト暗号化の設定を KMS へ変更</li><li>クラスター作成時の Spark 構成の設定値を追加<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>spark.hadoop.fs.s3a.server-side-encryption.key {CMK-ARN}
</span></span><span class=line><span class=cl>spark.hadoop.fs.s3a.server-side-encryption-algorithm SSE-KMS
</span></span></code></pre></div></li></ul></li></ul><h1 id=参考資料>参考資料</h1><ol><li><a href=https://docs.databricks.com/ja/security/keys/index.html>データのセキュリティと暗号化</a></li><li><a href=https://docs.databricks.com/ja/security/keys/customer-managed-keys.html>暗号化用のカスタマーマネージドキー</a></li><li><a href=https://docs.databricks.com/ja/security/keys/kms-s3.html>KMS を使用した S3 の暗号化の設定</a></li><li><a href=https://docs.databricks.com/ja/data-governance/unity-catalog/create-metastore.html>Unity Catalog メタストアを作成する</a></li><li><a href=https://docs.databricks.com/ja/security/keys/sql-encryption.html>クエリー、クエリー履歴、クエリー結果の暗号化</a></li></ol></section></article></main></div><div><footer id=site-footer class=toplevel-container><p>このサイトでは <a href=https://icons8.jp/>icons8</a> の素材を使用しています。</p><p>&copy; 2024 namoshika, All rights reserved</p></footer></div></div></body></html>