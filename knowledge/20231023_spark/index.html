<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="アーキテクチャ ノード Driver &mldr; 分散しない処理とExecutorの制御を行う Executor &mldr; 分散処理を行うノード 処理の構造 ジョブ &mldr; 複数のステージを内包。処理する"><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><meta name=generator content="Hugo 0.125.6"><title>Spark を使ってみる | Memo.Namo</title>
<meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/style/main.css></head><body><div class=flexbox><div><header id=site-header class=toplevel-container><h1><a href=/>Memo.Namo</a></h1><nav><ul class=horizontal-menu><li class=horizontal-menu-item><a href=/about/>About</a></li><li class=horizontal-menu-item><a href=/knowledge/>Knowledge</a></li></ul></nav></header><main id=site-main class=toplevel-container><article class="content-container content-grid"><header class=content-grid-header><div><a class=nav-category href=/knowledge/others/>Others</a><h1 class=content-grid-title>Spark を使ってみる</h1></div><p class=content-grid-desc><span>公開日: 2023-10-23</span>
<span>更新日: 2023-10-23</span></p></header><aside class=content-grid-side><div class=nav-sticky><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#アーキテクチャ>アーキテクチャ</a><ul><li><a href=#ノード>ノード</a></li><li><a href=#処理の構造>処理の構造</a></li></ul></li><li><a href=#データを入出力する>データを入出力する</a><ul><li><a href=#読み書き時-基本>読み書き時 (基本)</a></li><li><a href=#読み書き時-色々>読み書き時 (色々)</a></li><li><a href=#スキーマ>スキーマ</a></li><li><a href=#テーブル情報の取得>テーブル情報の取得</a></li><li><a href=#テーブルメンテナンス>テーブルメンテナンス</a></li></ul></li><li><a href=#データをクエリする>データをクエリする</a><ul><li><a href=#クエリ作成>クエリ作成</a></li><li><a href=#クエリ実行>クエリ実行</a></li><li><a href=#ユーザ定義関数>ユーザ定義関数</a></li></ul></li><li><a href=#sparksql-との相互運用>SparkSQL との相互運用</a></li></ul></nav><nav class=nav-tag><h2>タグ</h2><ul class=tag-container><li class="tag-item tag-item-inactive"><a href=/tags/auth/>Auth</a></li><li class="tag-item tag-item-inactive"><a href=/tags/businessman/>BusinessMan</a></li><li class="tag-item tag-item-inactive"><a href=/tags/database/>Database</a></li><li class="tag-item tag-item-active"><a href=/tags/dataengineering/>DataEngineering</a></li><li class="tag-item tag-item-inactive"><a href=/tags/datavisualization/>DataVisualization</a></li><li class="tag-item tag-item-inactive"><a href=/tags/devops/>DevOps</a></li><li class="tag-item tag-item-inactive"><a href=/tags/iac/>IaC</a></li><li class="tag-item tag-item-inactive"><a href=/tags/infrastructure/>Infrastructure</a></li></ul></nav></div></aside><section class="md-content content-grid-main"><h1 id=アーキテクチャ>アーキテクチャ</h1><h2 id=ノード>ノード</h2><ul><li>Driver &mldr; 分散しない処理とExecutorの制御を行う</li><li>Executor &mldr; 分散処理を行うノード</li></ul><h2 id=処理の構造>処理の構造</h2><ul><li>ジョブ &mldr; 複数のステージを内包。処理するファイルの文だけ作られる</li><li>ステージ &mldr; 複数のタスクを内包。単一ノード内で完結するタスクをまとめたもの</li><li>タスク</li></ul><h1 id=データを入出力する>データを入出力する</h1><ul><li>RDD &mldr; Spark がデータを扱う際の素のAPI.</li><li>DataFrame &mldr; pandas に似た API が提供されており扱いやすい.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># -----------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># RDD</span>
</span></span><span class=line><span class=cl><span class=c1># SparkContext を通して扱う</span>
</span></span><span class=line><span class=cl><span class=c1># -----------------------------</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>proc</span><span class=p>(</span><span class=n>val</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>val</span> <span class=o>*</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dt_lst</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=s2>&#34;aaa&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>dt_rdd</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sparkContext</span><span class=o>.</span><span class=n>parallelize</span><span class=p>(</span><span class=n>dt_lst</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dt_rdd</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>proc</span><span class=p>)</span><span class=o>.</span><span class=n>collect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -----------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># DataFrame </span>
</span></span><span class=line><span class=cl><span class=c1># SparkSession を通して扱う。</span>
</span></span><span class=line><span class=cl><span class=c1># このオブジェクトは RDD/Hive/SQL を束ねて扱うための仕組みとして提供されている。</span>
</span></span><span class=line><span class=cl><span class=c1># -----------------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 関数から生成</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配列から生成</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>createDataFrame</span><span class=p>([[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>]],</span> <span class=p>[</span><span class=s2>&#34;col1&#34;</span><span class=p>,</span> <span class=s2>&#34;col2&#34;</span><span class=p>,</span> <span class=s2>&#34;col3&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># フィールドの情報を取得</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>schema</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>printSchema</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 取得した DataFrame の内容を表示</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>display</span><span class=p>(</span><span class=n>dt_df</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=読み書き時-基本>読み書き時 (基本)</h2><p>SparkSQL での書き方</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- ファイルパスを指定して永続テーブル化する (SQL)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DROP</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>diamonds</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>diamonds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>USING</span><span class=w> </span><span class=n>CSV</span><span class=w> </span><span class=k>OPTIONS</span><span class=w> </span><span class=p>(</span><span class=n>path</span><span class=w> </span><span class=s2>&#34;/databricks-datasets/Rdatasets/data-001/csv/ggplot2/diamonds.csv&#34;</span><span class=p>,</span><span class=w> </span><span class=n>header</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- ファイルパスを指定して一時テーブル化する (SQL)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DROP</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>diamonds_tmp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=n>TEMP</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>diamonds_tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>USING</span><span class=w> </span><span class=n>CSV</span><span class=w> </span><span class=k>OPTIONS</span><span class=w> </span><span class=p>(</span><span class=n>path</span><span class=w> </span><span class=s2>&#34;/databricks-datasets/Rdatasets/data-001/csv/ggplot2/diamonds.csv&#34;</span><span class=p>,</span><span class=w> </span><span class=n>header</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- ファイルパスを指定してグローバル一時ビュー化する (SQL)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DROP</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>diamonds_tmp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>GLOBAL</span><span class=w> </span><span class=n>TEMP</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>diamonds_tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>USING</span><span class=w> </span><span class=n>CSV</span><span class=w> </span><span class=k>OPTIONS</span><span class=w> </span><span class=p>(</span><span class=n>path</span><span class=w> </span><span class=s2>&#34;/databricks-datasets/Rdatasets/data-001/csv/ggplot2/diamonds.csv&#34;</span><span class=p>,</span><span class=w> </span><span class=n>header</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>global_temp</span><span class=p>.</span><span class=n>diamonds_tmp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 指定したテーブルへデータロード
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>COPY</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>diamonds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=s1>&#39;/databricks-datasets/Rdatasets/data-001/csv/ggplot2/diamonds.csv&#39;</span><span class=w> </span><span class=n>FILEFORMAT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CSV</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>FORMAT_OPTIONS</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;inferSchema&#39;</span><span class=o>=</span><span class=s1>&#39;true&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;header&#39;</span><span class=o>=</span><span class=s1>&#39;true&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- ファイパスを指定してロードする
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>read_files</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;dbfs:/databricks-datasets/Rdatasets/data-001/csv/ggplot2/diamonds.csv&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>format</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;csv&#39;</span><span class=p>,</span><span class=w> </span><span class=n>header</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- format.`path` でもロードできる
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>binaryFile</span><span class=p>.</span><span class=o>`</span><span class=n>path</span><span class=err>\</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=o>`</span><span class=n>path</span><span class=err>\</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=nb>text</span><span class=p>.</span><span class=o>`</span><span class=n>path</span><span class=err>\</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>csv</span><span class=p>.</span><span class=o>`</span><span class=n>path</span><span class=err>\</span><span class=o>`</span><span class=w>
</span></span></span></code></pre></div><p>Python での書き方</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.sql.types</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># テーブルから生成</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>table</span><span class=p>(</span><span class=s2>&#34;samples.tpch.customer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ファイルパスを指定して読み込む (Python)</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>options</span><span class=p>(</span><span class=n>header</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>inferSchema</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>csv</span><span class=p>(</span><span class=s2>&#34;/databricks-datasets/retail-org/customers/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;csv&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>options</span><span class=p>(</span><span class=n>header</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>inferSchema</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;/databricks-datasets/Rdatasets/data-001/csv/ggplot2/diamonds.csv&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 一時テーブルを生成</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>createOrReplaceTempView</span><span class=p>(</span><span class=s2>&#34;diamonds_tmp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 永続テーブルを生成</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>write</span><span class=o>.</span><span class=n>saveAsTable</span><span class=p>(</span><span class=s2>&#34;diamonds&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 構造化ストリーミングで読み込み</span>
</span></span><span class=line><span class=cl><span class=c1># ストリーミングで読み込む場合にはスキーマ (後述) の指定が必要</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>readStream</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;csv&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>options</span><span class=p>(</span><span class=n>header</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>schema</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>StructType</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;customer_id&#39;</span><span class=p>,</span> <span class=n>IntegerType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;tax_id&#39;</span><span class=p>,</span> <span class=n>DoubleType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;tax_code&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;customer_name&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;state&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;city&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;postcode&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;street&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;number&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;unit&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;region&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;district&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;lon&#39;</span><span class=p>,</span> <span class=n>DoubleType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;lat&#39;</span><span class=p>,</span> <span class=n>DoubleType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;ship_to_address&#39;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;valid_from&#39;</span><span class=p>,</span> <span class=n>IntegerType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;valid_to&#39;</span><span class=p>,</span> <span class=n>DoubleType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;units_purchased&#39;</span><span class=p>,</span> <span class=n>DoubleType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>StructField</span><span class=p>(</span><span class=s1>&#39;loyalty_segment&#39;</span><span class=p>,</span> <span class=n>IntegerType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;/databricks-datasets/retail-org/customers/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>display</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=読み書き時-色々>読み書き時 (色々)</h2><p>色々なオプションが提供されている。</p><table><thead><tr><th>Prop</th><th>Desc</th><th>Default</th></tr></thead><tbody><tr><td>sep</td><td>区切り文字.</td><td>カンマ</td></tr><tr><td>encoding</td><td>文字コード</td><td>UTF-8</td></tr><tr><td>header</td><td>先頭行から項目名を取得するか</td><td>False</td></tr><tr><td>inferSchema</td><td>1度読み込んでスキーマを推測した後に改めて読み込む. 推測しない場合は全て文字列型になる. date型は未サポート</td><td>False</td></tr></tbody></table><p>SQL での書き方。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl</span><span class=w> </span><span class=k>AS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;aaa&#34;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;bbb&#34;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;ccc&#34;</span><span class=p>))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>col_a</span><span class=p>,</span><span class=w> </span><span class=n>col_b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=n>TEMP</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>sample_new</span><span class=w> </span><span class=k>AS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;ddd&#34;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;eee&#34;</span><span class=p>))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>col_a</span><span class=p>,</span><span class=w> </span><span class=n>col_b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 上書き
</span></span></span><span class=line><span class=cl><span class=c1>-- 新規やスキーマ変更は不可
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>INSERT</span><span class=w> </span><span class=n>OVERWRITE</span><span class=w> </span><span class=n>sample_tbl</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sample_new</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 新規やスキーマ変更も可能
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sample_new</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- マージ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>MERGE</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>sample_tbl</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=n>sample_new</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>col_a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>col_a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHEN</span><span class=w> </span><span class=n>MATCHED</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>col_b</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>col_b</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>col_b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>col_b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHEN</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>MATCHED</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=k>INSERT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- テーブルクローン  
</span></span></span><span class=line><span class=cl><span class=c1>-- シャローは複製元のファイルを参照する一方、ディープは全データをコピーする。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl_sc</span><span class=w> </span><span class=n>SHALLOW</span><span class=w> </span><span class=n>CLONE</span><span class=w> </span><span class=n>sample_tbl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl_dc</span><span class=w> </span><span class=n>DEEP</span><span class=w> </span><span class=n>CLONE</span><span class=w> </span><span class=n>sample_tbl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Generated Column
</span></span></span><span class=line><span class=cl><span class=c1>-- 値を自動で導出する
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>col_a</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>col_b</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>GENERATED</span><span class=w> </span><span class=n>ALWAYS</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>col_a</span><span class=w> </span><span class=o>*</span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>sample_tbl</span><span class=p>(</span><span class=n>col_a</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sample_tbl</span><span class=w>
</span></span></span></code></pre></div><p>Python での書き方。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># 参考: https://spark.apache.org/docs/latest/sql-data-sources-csv.html</span>
</span></span><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>read</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;inferSchema&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>options</span><span class=p>(</span><span class=n>inferSchema</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>csv</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>inferSchema</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 参考: https://spark.apache.org/docs/latest/sql-data-sources-parquet.html</span>
</span></span><span class=line><span class=cl><span class=c1># オプションの compression は parquet で書き出す際に使用できるオプション。  </span>
</span></span><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>write</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;compression&#34;</span><span class=p>,</span> <span class=s2>&#34;snappy&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>mode</span><span class=p>(</span><span class=s2>&#34;append|overwrite|error|ignore&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>parquet</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=スキーマ>スキーマ</h2><p>DataFrame は項目定義の情報としてスキーマを要する。<br>これはソースデータから推定する形で生成されるが、明示も可能。ストリーミングを使う際など推定が出来ない場合では明示することになる。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.sql.types</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配列から生成 (スキーマ明示)</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>createDataFrame</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;prop1&#34;</span><span class=p>:</span> <span class=mi>111</span><span class=p>,</span> <span class=s2>&#34;prop2&#34;</span><span class=p>:</span> <span class=s2>&#34;hoge1&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;prop1&#34;</span><span class=p>:</span> <span class=mi>222</span><span class=p>,</span> <span class=s2>&#34;prop2&#34;</span><span class=p>:</span> <span class=s2>&#34;hoge2&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;prop1&#34;</span><span class=p>:</span> <span class=mi>333</span><span class=p>,</span> <span class=s2>&#34;prop2&#34;</span><span class=p>:</span> <span class=s2>&#34;hoge3&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>StructType</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;RecordID&#34;</span><span class=p>,</span> <span class=n>IntegerType</span><span class=p>(),</span> <span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>StructField</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Info&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>StructType</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                <span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;prop1&#34;</span><span class=p>,</span> <span class=n>IntegerType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;prop2&#34;</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>スキーマは変更できる (スキーマ進化、スキーマ上書き)。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>write</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;compression&#34;</span><span class=p>,</span> <span class=s2>&#34;snappy&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=c1># スキーマを変更</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;mergeSchema|overwriteSchema&#34;</span><span class=p>,</span> <span class=s2>&#34;true&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>mode</span><span class=p>(</span><span class=s2>&#34;append|overwrite|error|ignore&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>parquet</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=テーブル情報の取得>テーブル情報の取得</h2><p>テーブルやビューの情報を見る際は DESCRIBE を使う。
メタデータを見たい場合は EXTENDED を付与する。保存場所が見たい場合は DETAIL を付与する</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>TEMP</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>sample_vw</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>col_a</span><span class=p>,</span><span class=w> </span><span class=n>col_b</span><span class=p>,</span><span class=w> </span><span class=n>col_c</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DESCRIBE</span><span class=w> </span><span class=n>EXTENDED</span><span class=w> </span><span class=n>SAMPLE_VW</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DESCRIBE</span><span class=w> </span><span class=n>DETAIL</span><span class=w> </span><span class=n>SAMPLE_VW</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Databricks で Delta Lake を使用していると使用可能
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DESCRIBE</span><span class=w> </span><span class=n>HISTORY</span><span class=w> </span><span class=n>SAMPLE_VW</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 各種オブジェクトの一覧を表示
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SHOW</span><span class=w> </span><span class=n>TABLES</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=n>SCHEMAS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=n>CATALOGS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>tablename</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>テーブルのプロパティとオプション</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- ビューやテーブルにカスタムプロパティを付与する
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>sample_vw</span><span class=w> </span><span class=n>TBLPROPERTIES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;prop_1&#39;</span><span class=o>=</span><span class=mi>123</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;prop_2&#39;</span><span class=o>=</span><span class=mi>234</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>col_a</span><span class=p>,</span><span class=w> </span><span class=n>col_b</span><span class=p>,</span><span class=w> </span><span class=n>col_c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- ビューやテーブルにオプションを付与する
</span></span></span><span class=line><span class=cl><span class=c1>-- https://learn.microsoft.com/ja-jp/azure/databricks/sql/language-manual/sql-ref-syntax-ddl-tblproperties
</span></span></span><span class=line><span class=cl><span class=c1>-- 一般的なオプション
</span></span></span><span class=line><span class=cl><span class=c1>-- * delta.appendOnly
</span></span></span><span class=line><span class=cl><span class=c1>-- * delta.dataSkippingNumIndexedCols
</span></span></span><span class=line><span class=cl><span class=c1>-- * delta.deletedFileRetentionDuration
</span></span></span><span class=line><span class=cl><span class=c1>-- * delta.logRetentionDuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl</span><span class=p>(</span><span class=n>col_a</span><span class=w> </span><span class=nb>integer</span><span class=p>,</span><span class=w> </span><span class=n>col_b</span><span class=w> </span><span class=nb>integer</span><span class=p>)</span><span class=w> </span><span class=k>OPTIONS</span><span class=w> </span><span class=p>(</span><span class=n>prop_1</span><span class=o>=</span><span class=mi>123</span><span class=p>,</span><span class=w> </span><span class=n>prop_2</span><span class=o>=</span><span class=mi>234</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>sample_vw</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>TBLPROPERTIES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;prop_3&#39;</span><span class=o>=</span><span class=s1>&#39;abc&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>sample_vw</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>TBLPROPERTIES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;prop_4&#39;</span><span class=o>=</span><span class=s1>&#39;bcd&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>sample_vw</span><span class=w> </span><span class=n>UNSET</span><span class=w> </span><span class=n>TBLPROPERTIES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;prop_4&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=n>TBLPROPERTIES</span><span class=w> </span><span class=n>sample_vw</span><span class=w>
</span></span></span></code></pre></div><h2 id=テーブルメンテナンス>テーブルメンテナンス</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>OPTIMIZE</span><span class=w> </span><span class=n>sample_tbl</span><span class=w> </span><span class=n>ZORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>col_a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>VACUUM</span><span class=w> </span><span class=n>sample_tbl</span><span class=w> </span><span class=p>[</span><span class=n>RETAIN</span><span class=w> </span><span class=mi>30</span><span class=w> </span><span class=n>HOURS</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><h1 id=データをクエリする>データをクエリする</h1><h2 id=クエリ作成>クエリ作成</h2><p>SQL で使用するワードを反映したメソッドを呼び出すことで集計できる。
複雑な条件を定義したい場合は項目に対し <code>pyspark.sql.Column</code> クラスのインスタンスを生成し、クラスのメソッドを使うことで定義できる。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.sql.functions</span> <span class=kn>import</span> <span class=n>col</span><span class=p>,</span> <span class=n>when</span><span class=p>,</span> <span class=n>otherwise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>table</span><span class=p>(</span><span class=s2>&#34;products&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>col</span><span class=p>(</span><span class=s2>&#34;price&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>200</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>orderBy</span><span class=p>(</span><span class=n>col</span><span class=p>(</span><span class=s2>&#34;price&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>desc</span><span class=p>(),</span> <span class=s2>&#34;name&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>select</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>col</span><span class=p>(</span><span class=s2>&#34;price&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>cast</span><span class=p>(</span><span class=s2>&#34;string&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>when</span><span class=p>(</span><span class=n>col</span><span class=p>(</span><span class=s2>&#34;price&#34;</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>otherwise</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 項目の取得には幾つかの方法がある。</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>columnName</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s2>&#34;columnName&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>col</span><span class=p>(</span><span class=s2>&#34;columnName&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Column クラスを用いる事で定義できる集計式は以下の通り。以下に幾つか列挙する。<br><a href=https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/column.html>https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/column.html</a></p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td>*, + , &lt;, >=, ==, !=</td><td>等価・比較演算子</td></tr><tr><td>alias</td><td>列にエイリアスを与えます</td></tr><tr><td>cast, astype</td><td>列を異なるデータ型にキャスト</td></tr><tr><td>isNull, isNotNull, isNan</td><td>null、非null、NaNの判断</td></tr><tr><td>asc, desc</td><td>列の昇順/降順</td></tr></tbody></table><p>Column クラスの生成は pyspark.sql.functions でメソッドが多く提供されている。<br>CASE 文などもこれを用いて表現する。<br><a href=https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/functions.html>https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/functions.html</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.sql.functions</span> <span class=kn>import</span> <span class=n>col</span><span class=p>,</span> <span class=n>when</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;hoge&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>when</span><span class=p>(</span><span class=n>col</span><span class=p>(</span><span class=s2>&#34;foo&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>,</span> <span class=s2>&#34;value1&#34;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>when</span><span class=p>(</span><span class=n>col</span><span class=p>(</span><span class=s2>&#34;foo&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;value2&#34;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>otherwise</span><span class=p>(</span><span class=s2>&#34;value3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td>ceil</td><td>指定された列を正の値の場合は切上げ、負の値の場合は切り下げする</td></tr><tr><td>cos</td><td>指定された値の余弦を計算する</td></tr><tr><td>log</td><td>指定された値の自然対数を計算する</td></tr><tr><td>round</td><td>HALF_UP丸めモードで0桁までの列eの値を返する</td></tr><tr><td>sqrt</td><td>指定された浮動小数点値の平方根を計算する</td></tr></tbody></table><p>グループ化したい場合は以下のようにする。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyspark.sql.functions</span> <span class=k>as</span> <span class=nn>F</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># グループ化</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>groupBy</span><span class=p>(</span><span class=s2>&#34;columnName&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>groupBy</span><span class=p>(</span><span class=s2>&#34;columnName1&#34;</span><span class=p>,</span> <span class=s2>&#34;columnName2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>groupBy</span><span class=p>([</span><span class=s2>&#34;columnName1&#34;</span><span class=p>,</span> <span class=s2>&#34;columnName2&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># グループ集計</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>groupBy</span><span class=p>(</span><span class=s2>&#34;columnName&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=s2>&#34;sumColumn1&#34;</span><span class=p>,</span> <span class=s2>&#34;sumColumn2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>groupBy</span><span class=p>(</span><span class=s2>&#34;columnName&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>agg</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>F</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=s2>&#34;sumColumn1&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>&#34;sumColumn1&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>F</span><span class=o>.</span><span class=n>avg</span><span class=p>(</span><span class=s2>&#34;avgColumn2&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>&#34;avgColumn2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>日付の扱いも pyspark.sql.functions に便利なメソッドが提供されている。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>spark</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>createDataFrame</span><span class=p>([(</span><span class=s2>&#34;2023-11-05 21:00:00&#34;</span><span class=p>,)],</span> <span class=p>[</span><span class=s2>&#34;date_text&#34;</span><span class=p>])</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>select</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>F</span><span class=o>.</span><span class=n>to_utc_timestamp</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>to_timestamp</span><span class=p>(</span><span class=s2>&#34;date_text&#34;</span><span class=p>,</span> <span class=s2>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>),</span> <span class=s2>&#34;Asia/Tokyo&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>&#34;date_dt&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>F</span><span class=o>.</span><span class=n>dayofweek</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>current_timestamp</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>        <span class=n>F</span><span class=o>.</span><span class=n>unix_timestamp</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>&#34;date_text&#34;</span><span class=p>),</span> <span class=s2>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>&#34;unixtime&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span></code></pre></div><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td>add_months(col: Column, months: int): Column</td><td>months ヶ月足す</td></tr><tr><td>current_timestamp(): Column</td><td>現在の日時</td></tr><tr><td>date_format(col: Column, format: str): Column</td><td>日付/タイムスタンプ/文字列を文字に変換</td></tr><tr><td>dayofweek(col: Column)</td><td>日曜～月曜を1～7の数値に変換</td></tr><tr><td>from_unixtime(col: Column, format: str)</td><td>Unixタイムを format 形式の文字列へ変換</td></tr><tr><td>minute(col: Column)</td><td>分を数値として抽出</td></tr><tr><td>unix_timestamp(col: Column, format: str)</td><td>format 形式で表現された日付を Unix タイムに変換</td></tr></tbody></table><p>pyspark.sql.functions には他にも便利な関数がある。</p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td>approx_count_distinct</td><td>一意のアイテムの近似数を返す</td></tr><tr><td>avg</td><td>平均値を返す</td></tr><tr><td>collect_list</td><td>重複を含むオブジェクトのリストを返す</td></tr><tr><td>corr</td><td>2つの列のピアソン相関係数を返す</td></tr><tr><td>max</td><td>最大値を計算する</td></tr><tr><td>mean</td><td>平均値を計算する</td></tr><tr><td>stddev_samp</td><td>サンプル標準偏差を返す</td></tr><tr><td>sumDistinct</td><td>式内の一意の値の合計を返す</td></tr><tr><td>var_pop</td><td>母集団分散を返す</td></tr><tr><td>split</td><td>項目の値を引数の値で分割する</td></tr></tbody></table><p>項目を新たに作ったり、名前を変更する場合は以下の通り。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># 項目作成</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;columnName&#34;</span><span class=p>,</span> <span class=n>col</span><span class=p>:</span> <span class=n>Column</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>withColumnRename</span><span class=p>(</span><span class=s2>&#34;oldColumnName&#34;</span><span class=p>,</span> <span class=s2>&#34;newColumnName&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 項目削除</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=s2>&#34;columnName&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># データフレーム統合</span>
</span></span><span class=line><span class=cl><span class=c1># union all 相当. 統合対象のスキーマは順序レベルで同一にする必要があるが、ByName の場合は項目名で突合される</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>union</span><span class=p>(</span><span class=n>df_df2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>unionByName</span><span class=p>(</span><span class=n>df_df2</span><span class=p>)</span>
</span></span></code></pre></div><p>欠落データに対するメソッドをまとめたものとして <a href=https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrameNaFunctions.html>pyspark.sql.DataFrameNaFunctions</a> もある。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># null 行の削除</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>how</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;any(default)|all&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>thresh</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>subset</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=kc>None</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># null 列へ代替値を代入</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>subset</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=c1># 任意の値へ代替値を代入. dt_df.replace のエイリアス</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>newvalue</span><span class=p>,</span> <span class=n>oldvalue</span><span class=p>,</span> <span class=n>subset</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]])</span>
</span></span></code></pre></div><p>テーブル結合の操作は以下の通り。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>joined_df</span> <span class=o>=</span> <span class=n>dt_df</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>other</span><span class=o>=</span><span class=n>dt_df2</span><span class=p>,</span> <span class=n>on</span><span class=o>=</span><span class=s1>&#39;columnName&#39;</span><span class=p>,</span> <span class=n>how</span> <span class=o>=</span> <span class=s2>&#34;inner&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>ネストデータの扱いは以下の通り。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyspark.sql.types</span> <span class=k>as</span> <span class=nn>T</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyspark.sql.functions</span> <span class=k>as</span> <span class=nn>F</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># リストオブジェクトを定義したデータフレームを定義</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>createDataFrame</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=p>[{</span><span class=s2>&#34;prop1&#34;</span><span class=p>:</span> <span class=mi>111</span><span class=p>,</span> <span class=s2>&#34;prop2&#34;</span><span class=p>:</span> <span class=s2>&#34;hoge1&#34;</span><span class=p>},</span> <span class=p>{</span><span class=s2>&#34;prop1&#34;</span><span class=p>:</span> <span class=mi>222</span><span class=p>,</span> <span class=s2>&#34;prop2&#34;</span><span class=p>:</span> <span class=s2>&#34;hoge2&#34;</span><span class=p>}]),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=p>[{</span><span class=s2>&#34;prop1&#34;</span><span class=p>:</span> <span class=mi>444</span><span class=p>,</span> <span class=s2>&#34;prop2&#34;</span><span class=p>:</span> <span class=s2>&#34;hoge1&#34;</span><span class=p>},</span> <span class=p>{</span><span class=s2>&#34;prop1&#34;</span><span class=p>:</span> <span class=mi>555</span><span class=p>,</span> <span class=s2>&#34;prop2&#34;</span><span class=p>:</span> <span class=s2>&#34;hoge2&#34;</span><span class=p>}]),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=p>[{</span><span class=s2>&#34;prop1&#34;</span><span class=p>:</span> <span class=mi>777</span><span class=p>,</span> <span class=s2>&#34;prop2&#34;</span><span class=p>:</span> <span class=s2>&#34;hoge1&#34;</span><span class=p>},</span> <span class=p>{</span><span class=s2>&#34;prop1&#34;</span><span class=p>:</span> <span class=mi>888</span><span class=p>,</span> <span class=s2>&#34;prop2&#34;</span><span class=p>:</span> <span class=s2>&#34;hoge2&#34;</span><span class=p>}]),</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>T</span><span class=o>.</span><span class=n>StructType</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;RecordID&#34;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>IntegerType</span><span class=p>(),</span> <span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Info&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>T</span><span class=o>.</span><span class=n>ArrayType</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>T</span><span class=o>.</span><span class=n>StructType</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                    <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;prop1&#34;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>IntegerType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;prop2&#34;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># リストオブジェクトを展開</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span> <span class=o>=</span> <span class=n>dt_df</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;Info&#34;</span><span class=p>,</span> <span class=n>F</span><span class=o>.</span><span class=n>explode</span><span class=p>(</span><span class=s2>&#34;Info&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 行展開をリストオブジェクトへ戻す</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span> <span class=o>=</span> <span class=n>dt_df</span><span class=o>.</span><span class=n>groupBy</span><span class=p>(</span><span class=s2>&#34;RecordID&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>agg</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>collect_list</span><span class=p>(</span><span class=s2>&#34;Info&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span></code></pre></div><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td>explode(col: Column)</td><td>リストオブジェクトを行方向へ展開</td></tr><tr><td>collect_list(col: Column)</td><td>グループ化された項目をリストオブジェクトへ変換 (重複有り)</td></tr><tr><td>collect_set(col: Column)</td><td>グループ化された項目をリストオブジェクトへ変換 (重複無し)</td></tr><tr><td>flatten(col: Column)</td><td>複数の配列を単一の配列に結合</td></tr></tbody></table><p>サブフィールドを参照</p><ul><li><code>Object:Field</code> &mldr; JSON として Field を参照</li><li><code>Object.Field</code> &mldr; StructType として StructField を参照</li></ul><p>スキーマを扱う</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyspark.sql.functions</span> <span class=k>as</span> <span class=nn>F</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyspark.sql.types</span> <span class=k>as</span> <span class=nn>T</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># JSON からスキーマ情報を生成]</span>
</span></span><span class=line><span class=cl><span class=c1># schema = T.StructType([T.StructField(&#34;hoge&#34;, T.IntegerType())])</span>
</span></span><span class=line><span class=cl><span class=n>schema</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>schema_of_json</span><span class=p>(</span><span class=s2>&#34;{&#39;hoge&#39;: 123}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># JSON 文字列と JSON Schema から StructType を生成</span>
</span></span><span class=line><span class=cl><span class=n>spark</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>createDataFrame</span><span class=p>([[</span><span class=s2>&#34;{&#39;hoge&#39;: 123}&#34;</span><span class=p>]],</span> <span class=s2>&#34;val string&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;hoge&#34;</span><span class=p>,</span> <span class=n>F</span><span class=o>.</span><span class=n>from_json</span><span class=p>(</span><span class=s2>&#34;val&#34;</span><span class=p>,</span> <span class=n>schema</span><span class=p>))</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span></code></pre></div><p>ピボット</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=n>temp</span><span class=w> </span><span class=k>view</span><span class=w> </span><span class=n>sample_tbl</span><span class=w> </span><span class=k>AS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>(</span><span class=s1>&#39;grp_a&#39;</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>(</span><span class=s1>&#39;grp_a&#39;</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>(</span><span class=s1>&#39;grp_b&#39;</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>(</span><span class=s1>&#39;grp_c&#39;</span><span class=p>,</span><span class=mi>4</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>(</span><span class=s1>&#39;grp_c&#39;</span><span class=p>,</span><span class=mi>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>dimention</span><span class=p>,</span><span class=w> </span><span class=n>measure</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sample_tbl</span><span class=w> </span><span class=n>PIVOT</span><span class=w> </span><span class=p>(</span><span class=k>sum</span><span class=p>(</span><span class=n>measure</span><span class=p>)</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>dimention</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;grp_a&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;grp_b&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;grp_c&#34;</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>table</span><span class=p>(</span><span class=s2>&#34;sample_tbl&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>groupBy</span><span class=p>(</span><span class=s2>&#34;dimention&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>pivot</span><span class=p>(</span><span class=s2>&#34;dimention&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>sum</span><span class=p>()</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=クエリ実行>クエリ実行</h2><p>Spark では集計処理を書いただけでは処理は行われない。遅延評価を実行するメソッドを呼び出すことで処理が実行される。</p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td>collect, first, head, take</td><td>全/最初の1/最初のn行を返す</td></tr><tr><td>count</td><td>行数を返す</td></tr><tr><td>show</td><td>上位n行を表形式で表示</td></tr><tr><td>describe, summary</td><td>数値および文字列の列に対する基本統計を計算</td></tr></tbody></table><p>キャッシュ機能は以下の通り</p><ul><li>DataFrame.cache</li><li>DataFrame.unpersist</li></ul><h2 id=ユーザ定義関数>ユーザ定義関数</h2><p>SQL で定義する場合は以下の通り。定義・実行には以下の権限を要する。</p><table><thead><tr><th>Type</th><th>USE CATALOG</th><th>USE SCHEMA</th><th>CREATE FUNCTION</th><th>EXECUTE</th></tr></thead><tbody><tr><td>create</td><td>yes</td><td>yes</td><td>yes</td><td>no</td></tr><tr><td>execute</td><td>yes</td><td>yes</td><td>no</td><td>yes</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 関数定義
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>hoge_func</span><span class=p>(</span><span class=n>val</span><span class=w> </span><span class=n>string</span><span class=p>)</span><span class=w> </span><span class=k>RETURNS</span><span class=w> </span><span class=n>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>RETURN</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s2>&#34;aaa&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 情報取得
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DESC</span><span class=w> </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>extended</span><span class=w> </span><span class=n>hoge_func</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 関数実行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>hoge_func</span><span class=p>(</span><span class=s2>&#34;hoge&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>python 上で使いたい場合は以下のように定義する。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyspark.sql.types</span> <span class=k>as</span> <span class=nn>T</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyspark.sql.functions</span> <span class=k>as</span> <span class=nn>F</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Iterator</span><span class=p>,</span> <span class=n>Tuple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Scalar to Scalar 型</span>
</span></span><span class=line><span class=cl><span class=nd>@F.udf</span><span class=p>(</span><span class=s2>&#34;int&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sample_s2s</span><span class=p>(</span><span class=n>val</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vector to Vector 型 (即時評価型)</span>
</span></span><span class=line><span class=cl><span class=nd>@F.pandas_udf</span><span class=p>(</span><span class=s2>&#34;int&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sample_v2v1</span><span class=p>(</span><span class=n>val</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>val</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vector to Vector 型 (遅延評価型)</span>
</span></span><span class=line><span class=cl><span class=nd>@F.pandas_udf</span><span class=p>(</span><span class=s2>&#34;int&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sample_v2v2</span><span class=p>(</span><span class=n>vals</span><span class=p>:</span> <span class=n>Iterator</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Iterator</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>v</span> <span class=o>+</span> <span class=mi>1</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>vals</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Matrics to Vector 型 (遅延評価型)</span>
</span></span><span class=line><span class=cl><span class=nd>@F.pandas_udf</span><span class=p>(</span><span class=s2>&#34;int&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sample_m2v</span><span class=p>(</span><span class=n>vals</span><span class=p>:</span> <span class=n>Iterator</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>]])</span> <span class=o>-&gt;</span> <span class=n>Iterator</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>v1</span> <span class=o>+</span> <span class=n>v2</span> <span class=k>for</span> <span class=n>v1</span><span class=p>,</span><span class=n>v2</span> <span class=ow>in</span> <span class=n>vals</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vector to Scalar 型: </span>
</span></span><span class=line><span class=cl><span class=nd>@F.pandas_udf</span><span class=p>(</span><span class=s2>&#34;int&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sample_v2s</span><span class=p>(</span><span class=n>val</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>val</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dat_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>createDataFrame</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=s2>&#34;111&#34;</span><span class=p>,</span> <span class=s2>&#34;222&#34;</span><span class=p>,</span> <span class=mi>111</span><span class=p>,</span> <span class=mi>222</span><span class=p>,</span> <span class=s2>&#34;aaa&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=s2>&#34;444&#34;</span><span class=p>,</span> <span class=s2>&#34;555&#34;</span><span class=p>,</span> <span class=mi>444</span><span class=p>,</span> <span class=mi>555</span><span class=p>,</span> <span class=s2>&#34;aaa&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>T</span><span class=o>.</span><span class=n>StructType</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;prop1&#34;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>StringType</span><span class=p>(),</span> <span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;prop2&#34;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>StringType</span><span class=p>(),</span> <span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;prop3&#34;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>IntegerType</span><span class=p>(),</span> <span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;prop4&#34;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>IntegerType</span><span class=p>(),</span> <span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&#34;prop5&#34;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>StringType</span><span class=p>(),</span> <span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dat_df</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;sample_s2s&#34;</span><span class=p>,</span> <span class=n>sample_s2s</span><span class=p>(</span><span class=s2>&#34;prop1&#34;</span><span class=p>))</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;sample_v2v1&#34;</span><span class=p>,</span> <span class=n>sample_v2v1</span><span class=p>(</span><span class=s2>&#34;prop2&#34;</span><span class=p>))</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;sample_v2v2&#34;</span><span class=p>,</span> <span class=n>sample_v2v2</span><span class=p>(</span><span class=s2>&#34;prop3&#34;</span><span class=p>))</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;sample_m2v&#34;</span><span class=p>,</span> <span class=n>sample_m2v</span><span class=p>(</span><span class=s2>&#34;prop3&#34;</span><span class=p>,</span> <span class=s2>&#34;prop4&#34;</span><span class=p>))</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># .printSchema()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dat_df</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=n>sample_v2s</span><span class=p>(</span><span class=s2>&#34;prop3&#34;</span><span class=p>))</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># .printSchema()</span>
</span></span></code></pre></div><h1 id=sparksql-との相互運用>SparkSQL との相互運用</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># DataFrame を SparkSQL から生成</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM samples.tpch.customer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># DataFrame を SparkSQL から参照できるよう登録する</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>createOrReplaceTempView</span><span class=p>(</span><span class=s2>&#34;hoge&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SparkSQL で登場する式を使用して各値を取り出せる</span>
</span></span><span class=line><span class=cl><span class=n>dt_df</span><span class=o>.</span><span class=n>selectExpr</span><span class=p>(</span><span class=s2>&#34;expr1&#34;</span><span class=p>,</span> <span class=s2>&#34;expr2&#34;</span> <span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Python UDF を SQL 側で使えるようにする</span>
</span></span><span class=line><span class=cl><span class=n>dat_df</span><span class=o>.</span><span class=n>createOrReplaceTempView</span><span class=p>(</span><span class=s2>&#34;dat_df&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>udf</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=s2>&#34;sample_vcudf&#34;</span><span class=p>,</span> <span class=n>sample_vcudf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=p>(</span><span class=s2>&#34;select * from dat_df limit 10&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span></code></pre></div></section></article></main></div><div><footer id=site-footer class=toplevel-container><p>このサイトでは <a href=https://icons8.jp/>icons8</a> の素材を使用しています。</p><p>&copy; 2024 namoshika, All rights reserved</p></footer></div></div></body></html>