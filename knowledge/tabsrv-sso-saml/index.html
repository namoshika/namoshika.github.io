<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="ログイン1回でどこでも TableauServerのSAML シングルサインオン (以下SSO) を構成してみます。これができると、認証基盤側で1度"><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><meta name=generator content="Hugo 0.125.6"><title>SAML で SSO を構成する | Memo.Namo</title>
<meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/style/main.css></head><body><div class=flexbox><div><header id=site-header class=toplevel-container><h1><a href=/>Memo.Namo</a></h1><nav><ul class=horizontal-menu><li class=horizontal-menu-item><a href=/about/>About</a></li><li class=horizontal-menu-item><a href=/knowledge/>Knowledge</a></li></ul></nav></header><main id=site-main class=toplevel-container><article class="content-container content-grid"><header class=content-grid-header><div><a class=nav-category href=/knowledge/tableau/>Tableau</a><h1 class=content-grid-title>SAML で SSO を構成する</h1></div><p class=content-grid-desc><span>公開日: 2021-11-27</span>
<span>更新日: 2021-11-27</span></p></header><aside class=content-grid-side><div class=nav-sticky><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ログイン1回でどこでも>ログイン1回でどこでも</a></li><li><a href=#samlとは>SAMLとは</a><ul><li><a href=#登場する用語>登場する用語</a></li><li><a href=#認証シーケンス>認証シーケンス</a></li></ul></li><li><a href=#必要なもの>必要なもの</a><ul><li><a href=#1-idp-側>1. IdP 側</a></li><li><a href=#2-tableauserver-側>2. TableauServer 側</a></li></ul></li><li><a href=#やってみる>やってみる</a><ul><li><a href=#1-tableauserverを構築>1. TableauServerを構築</a></li><li><a href=#2-tableau-を構成-12>2. Tableau を構成 (1/2)</a></li><li><a href=#3-idp-azure-ad-を構成>3. IdP (Azure AD) を構成</a></li><li><a href=#4-tableau-を構成-22>4. Tableau を構成 (2/2)</a></li><li><a href=#5-動作チェック>5. 動作チェック</a></li></ul></li><li><a href=#ログインに成功しない時には>ログインに成功しない時には</a><ul><li><a href=#ログインに失敗する1>ログインに失敗する1</a></li><li><a href=#ログインに失敗する2>ログインに失敗する2</a></li><li><a href=#ログインに失敗する3>ログインに失敗する3</a></li><li><a href=#ログアウトが成功しない>ログアウトが成功しない</a></li><li><a href=#アプリからのログインが完了しない>アプリからのログインが完了しない</a></li></ul></li><li><a href=#参考資料>参考資料</a></li></ul></nav><nav class=nav-tag><h2>タグ</h2><ul class=tag-container><li class="tag-item tag-item-active"><a href=/tags/auth/>Auth</a></li><li class="tag-item tag-item-inactive"><a href=/tags/businessman/>BusinessMan</a></li><li class="tag-item tag-item-inactive"><a href=/tags/database/>Database</a></li><li class="tag-item tag-item-inactive"><a href=/tags/dataengineering/>DataEngineering</a></li><li class="tag-item tag-item-inactive"><a href=/tags/datavisualization/>DataVisualization</a></li><li class="tag-item tag-item-inactive"><a href=/tags/devops/>DevOps</a></li><li class="tag-item tag-item-inactive"><a href=/tags/iac/>IaC</a></li><li class="tag-item tag-item-inactive"><a href=/tags/infrastructure/>Infrastructure</a></li></ul></nav></div></aside><section class="md-content content-grid-main"><h1 id=ログイン1回でどこでも>ログイン1回でどこでも</h1><p>TableauServerのSAML シングルサインオン (以下SSO) を構成してみます。これができると、認証基盤側で1度ログインすれば TableauServer やその他の SSO 対応アプリ間では二度とログイン画面を見なくて済みます。現実は中々そうはいきませんが、パスワード何回も入れるとか馬鹿らしいよね！ (どうせ同じパスワードだよ？)</p><p>記事の方針は以下とします。</p><ul><li>SAML SSO の概要を知る (細かい仕様には切り込みません。英語仕様書に心が折れた&mldr;)</li><li>SSO構成を設定してみる (記事では認証基盤側にAzureADを使います)</li><li>上手くいかない時のチェックポイント (SSO初体験 & 実績無しIdPで苦戦したよ&mldr;(´；ω；｀)</li></ul><h1 id=samlとは>SAMLとは</h1><p>SAML とは、OASIS3によって策定された異なるセキュリティドメイン間で認証情報を連携するための XML ベースな標準仕様です。</p><p>一般ユーザ向けには Twitter や Google による OAuth を用いた独自の実装が普及してますが、企業内で使用されるシステムの認証には標準化された SAML がよく用いられているようです (AD認証が広く使われてきましたが、クラウドサービスの時代はドメインをまたげるSAMLが多くなるんですかね)。</p><p>同じような技術を OAuth ベースに標準化したものとして OpenID Connect があるようですが、イマイチ流行ってないんじゃないかな。</p><h2 id=登場する用語>登場する用語</h2><p>ブラウザ SSO に関係する要素を列挙。 SOAP を使用できたり柔軟性があるようですが、ここではスルー。</p><table><thead><tr><th>用語</th><th>解説</th></tr></thead><tbody><tr><td>Metadata</td><td>SSOに必要なエンドポイントURLや証明書などを記述したXML。IdP、SPそれぞれが生成でき、あると双方の設定が楽。中には <code>&lt;EntityDescriptor></code> が確認できる</td></tr><tr><td>Binding</td><td>アサーションをやり取りする際の方式。 HTTP-Redirect や HTTP-POST などがある</td></tr><tr><td>EntityID</td><td>SP/IdP 間で共有する認識子</td></tr><tr><td>Endpoint URL</td><td>SP/IdP 間でデータのやり取りに使われるURL。SPメタデータでは<code>&lt;md:AssertionConsumerService></code> 、IdPメタデータでは <code>&lt;SingleSignOnService></code> で確認できる</td></tr></tbody></table><p>深堀りしていくと、以下の概念が登場してきます。</p><table><thead><tr><th>用語</th><th>解説</th></tr></thead><tbody><tr><td>Profile</td><td>ユースケースにおけるバインディングやプロトコルのまとめ</td></tr><tr><td>IdP / SP / Subject</td><td>IdPはユーザ認証の機能を提供する。SPは提供される認証情報を利用。認証される対象 (ユーザ) はサブジェクトと表現される。まとめてパーティと呼ばれたりする。</td></tr><tr><td>Assertion</td><td>IdPが対象を証明するためにSPへ発行するデータ。中に <code>&lt;Subject></code> とそれに紐付く0個以上のステートメントを持つ</td></tr><tr><td>Statement</td><td>アサーションの中に格納されているもの。 <code>&lt;AttributeStatement></code> 、 <code>&lt;AuthnStatement></code> などが使われる</td></tr></tbody></table><p>SAML仕様書は以下から成ります。正確には SAML 2.0 です。<br><a href=https://wiki.oasis-open.org/security/FrontPage>https://wiki.oasis-open.org/security/FrontPage</a></p><table><thead><tr><th>仕様書</th><th>説明</th></tr></thead><tbody><tr><td>Core</td><td>SP/IdP 間でやり取りされる メッセージXML の仕様</td></tr><tr><td>Binding</td><td>メッセージやり取り方法の仕様。 ブラウザ上での動きはこの辺</td></tr><tr><td>Profile</td><td>良く分からん。ここら辺で気力が&mldr;</td></tr><tr><td>Metadata</td><td>SP/IdP 間で信頼関係を設定する際に使う設定記述XMLの仕様</td></tr></tbody></table><h2 id=認証シーケンス>認証シーケンス</h2><p>認証シーケンスを SP から始めるのか (SP-initiated) 、 IdP から始めるのか (IdP-initiated) で2種類あります。以下のシーケンスは SP-initiated の場合を記述しており、 IdP-initiated の場合は 3番から開始され、それ以降はほぼ同じです。</p><ol><li>ユーザがブラウザで SP へアクセス</li><li>SP から IdP へリダイレクト。 (SPから <code>&lt;saml2p:AuthnRequest></code> が渡ります)</li><li>IdP がユーザへログインページを表示</li><li>ユーザがログインページへ認証情報を入力</li><li>IdP がユーザを適正と認証できたら、 SP へリダイレクト。</li><li>ブラウザがIdPのレスポンスに従いSPへリダイレクト<br>(IdPから <code>&lt;samlp:Response></code> が渡ります。中に <code>&lt;Assertion></code> が含まれます)</li><li>SP はログイン後のページをユーザへ表示</li></ol><p><img src=image/tabsrv-sso-saml.gif alt=sp-initiated.gif><br><a href=http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-tech-overview-2.0-cd-02.html#5.1.2.SP-Initiated%20SSO:%20%20Redirect/POST%20Bindings%7Coutline>Copyright © OASIS Open 2008. All Rights Reserved</a></p><h1 id=必要なもの>必要なもの</h1><p>SAML要件 (<a href=https://onlinehelp.tableau.com/current/server/ja-jp/saml_requ.htm>参考資料1</a>) を熟読し、SP/IdPに必要な要素のチェックリストを作った方が良いです。</p><h2 id=1-idp-側>1. IdP 側</h2><ul><li>テストユーザ</li><li>SAML SP メタデータ &mldr; TableauServer から持ってくる</li><li>ADFS 属性の設定 &mldr; 認証成功時に IdP から TableauServer へ username 属性を渡す設定が必要</li><li>RelayState の設定 &mldr; ログインには TableauServer から渡される RelayState を IdP は送り返せる必要有り</li></ul><h2 id=2-tableauserver-側>2. TableauServer 側</h2><ul><li>IdPに登録されたテストユーザ &mldr; アカウント自体は事前に作成が必要</li><li>SAML IdP メタデータ &mldr; IdP から持ってくる。TableauServer は POST binding のみ対応</li><li>SAML 証明書 & 鍵 &mldr; SPメタデータ経由でIdPへも渡る。シングルログアウトが要件になければIdPには必要なかったりする。</li></ul><h1 id=やってみる>やってみる</h1><p>Azure AD で即席 IdP を作り、TableauServer へ設定してみます。
Azure AD には TableauServer への設定のチュートリアル (<a href=https://docs.microsoft.com/ja-jp/azure/active-directory/saas-apps/tableauserver-tutorial>参考資料2</a>) があり、練習にはもってこいです。</p><h2 id=1-tableauserverを構築>1. TableauServerを構築</h2><ol><li>TableauServerを起動した仮想マシンを用意</li><li>ローカル認証でセットアップ<br>(アイデンティティストアは TableauServer が持つ必要があります。SAMLは認証を担いますが、認可は TableauServer が行うためです)</li><li>SSLを有効化<br>(Azure AD では SSL 無効の URL は登録できませんでした。記事ではSAMLを構成する際に作る証明書を使い回しました)</li></ol><h2 id=2-tableau-を構成-12>2. Tableau を構成 (1/2)</h2><p>PowerShell を起動し、SAML認証時のTableauServer用証明書を発行します。
著者の場合、SSLで使い回すためにCSR発行時に CommonName として TableauServer のドメインを入れてます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$env:Path</span> <span class=p>+=</span> <span class=s2>&#34;;C:\Program Files\Tableau\Tableau Server\packages\apache.20192.19.0718.1543\bin;&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$env:OPENSSL_CONF</span> <span class=p>=</span> <span class=s2>&#34;C:\Program Files\Tableau\Tableau Server\packages\apache.20192.19.0718.1543\conf\openssl.cnf&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>openssl</span> <span class=n>genrsa</span> <span class=n>-out</span> <span class=n>tabsrv</span><span class=p>.</span><span class=py>key</span> <span class=mf>4096</span>
</span></span><span class=line><span class=cl><span class=n>openssl</span> <span class=n>req</span> <span class=n>-new</span> <span class=n>-key</span> <span class=n>tabsrv</span><span class=p>.</span><span class=py>key</span> <span class=n>-x509</span> <span class=n>-days</span> <span class=mf>365</span> <span class=n>-out</span> <span class=n>tabsrv</span><span class=p>.</span><span class=py>crt</span> <span class=n>-addext</span> <span class=s1>&#39;subjectAltName = IP:${アドレス(SSLのChromeエラー避け)}&#39;</span>
</span></span></code></pre></div><p>SAML認証の設定をします。</p><ol><li>TSMを開き、[Configuration] - [ユーザ認証とアクセス] - [認証方法] を開く</li><li>認証方法から「SAML」を選択</li><li>「SAML認証を有効化」のチェックを入れる</li><li>「Tableau Server リターン URL」へTableauServerのURLを入れる (ex: <code>https://domain</code>。末尾にスラッシュは付けないこと)</li><li>「SAMLエンティティID」へIdPと共有する認識子を入れる (ex: <code>domain</code>。大抵はTableauServerのドメインを入れる)</li><li>Tableau Server 側のSAML用の証明書と鍵をアップロード</li><li>メタデータをダウンロード (まだ再起動は不要です)</li></ol><h2 id=3-idp-azure-ad-を構成>3. IdP (Azure AD) を構成</h2><p>既定ディレクトリへログイン用のユーザを作成。ここでは hoge ユーザを作ります。</p><ol><li>Azure Portal から Azure Active Directory を開く</li><li>既定ディレクトリから「ユーザ」を開き、「新しいユーザー」をクリック</li><li>割り当ての追加から「ユーザー」を選択。</li><li>「名前」に hoge、「ユーザ名」に hoge@domain (domain部分はAzureADの既定ディレクトリの「概要」から確認できます) を入力</li><li>パスワードを控えておく</li><li>「作成」をクリック</li></ol><p>エンタープライズアプリケーションを追加します。</p><ol><li>Azure AD から「エンタープライズアプリケーション」を開き「新しいアプリケーション」をクリック</li><li>ギャラリーから"Tableau Server"を検索し、追加をクリック</li></ol><p>追加されたTableauServerへシングル サインオンを設定。</p><ol><li>Azure AD のエンタープライズアプリから Tableau Server を開く</li><li>シングル サインオン をクリックし、SAMLを選択</li><li>「メタデータ ファイルをアップロードする」をクリックし、TableauServer からダウンロードしたメタデータをアップロード</li><li>「サインオン URL」に TableauServer のURLを入力</li><li>「保存」をクリック</li></ol><p>ユーザー属性とクレームから username 属性の付与を設定。</p><ol><li>ユーザー属性とクレームを編集し、「新しいクレームの追加」を押す</li><li>「名前」に &ldquo;username&rdquo; 、「ソース」に「属性」を選択、「ソース属性」に &ldquo;user.userprincipalname&rdquo; を入力</li><li>「保存」をクリック</li></ol><p>IdPのメタデータをダウンロード。
SAML 署名証明書から「フェデレーション メタデータ XML」をクリックします。</p><h2 id=4-tableau-を構成-22>4. Tableau を構成 (2/2)</h2><p>TableauServer へ Azure AD で作成したユーザを追加します。</p><ol><li>TableauServer へ管理者としてログイン</li><li>[ユーザー] を開き、 [+ユーザの追加] を押し、 [新規ユーザー] をクリック</li><li>「ユーザー名」に Azure AD で作成したユーザーのID (ex: hoge@domain) を入力。その他は適当に埋める</li><li>「ユーザーの追加」をクリック</li></ol><p>TableauServer へ IdP の設定を入力</p><ol><li>TSMを開き、[Configuration] - [ユーザ認証とアクセス] - [認証方法] を開く</li><li>「SAML IdP metadata file」から IdP で発行したメタデータXMLをアップロード</li><li>「Save Pending Changes」をクリック (まだ再起動は不要です)</li></ol><h2 id=5-動作チェック>5. 動作チェック</h2><p>ブラウザ、Desktop, Mobileでチェック。
ブラウザでの認証はシークレットモードを推奨。認証に失敗してもブラウザを開き直せばやり直せて楽です。</p><ul><li>ログインができること</li><li>ワークブックを開けること</li><li>ログアウトができること (要件になかったりとスルー可能な事が多い)</li></ul><h1 id=ログインに成功しない時には>ログインに成功しない時には</h1><p>デバッグ用にSAML認証のやり取りを覗く拡張機能を入れたChromeもインストールすると便利です (著者は <a href=https://chrome.google.com/webstore/detail/saml-devtools-extension/jndllhgbinhiiddokbeoeepbppdnhhio>SAML DevTools extension</a> を使用)。</p><p>認証はvizportalで行われてます。 vizportal ログレベルを debug へ変更するとログ出力場所 (<code>C:\ProgramData\Tableau\Tableau Server\data\tabsvc\logs\vizportal\vizportal_node1-0.log</code>) にSAML認証の詳細が書き出されるようになり、SP側エラーについてはかなり分かります。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># vizportal のログレベルを debug に設定</span>
</span></span><span class=line><span class=cl><span class=n>tsm</span> <span class=kd>configuration</span><span class=w> </span><span class=nb>set </span><span class=n>-k</span> <span class=n>vizportal</span><span class=p>.</span><span class=py>log</span><span class=p>.</span><span class=py>level</span> <span class=n>-v</span> <span class=n>debug</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 保留中の変更を列挙</span>
</span></span><span class=line><span class=cl><span class=n>tsm</span> <span class=nb>pending-changes</span> <span class=n>list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># TableauServer を再起動</span>
</span></span><span class=line><span class=cl><span class=n>tsm</span> <span class=n>restart</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 設定を既定値へ戻す (デバッグが済んだら設定を戻しましょう)</span>
</span></span><span class=line><span class=cl><span class=c># tsm configuration set -k vizportal.log.level -d</span>
</span></span></code></pre></div><h2 id=ログインに失敗する1>ログインに失敗する1</h2><p>IdP の SAML Response に username 属性が無い場合には以下のログが残ります。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2019-07-28 02:06:14.095 +0000 (,,,,) catalina-exec-1 : ERROR com.tableausoftware.saml.SAMLExtendedProcessingFilter - SAML Authentication Failed, please contact the administrator.
</span></span><span class=line><span class=cl>org.springframework.security.authentication.AuthenticationServiceException: Incoming SAML message has no valid value for username attribute. Please verify ServiceProvider configuration in Identity Provider.
</span></span><span class=line><span class=cl>	at com.tableausoftware.saml.SAMLExtendedProcessingFilter.getUser(SAMLExtendedProcessingFilter.java:507)
</span></span><span class=line><span class=cl>	at com.tableausoftware.saml.SAMLExtendedProcessingFilter.handleSuccess(SAMLExtendedProcessingFilter.java:255)
</span></span><span class=line><span class=cl>	at com.tableausoftware.saml.SAMLExtendedProcessingFilter.attemptAuthentication(SAMLExtendedProcessingFilter.java:219)
</span></span></code></pre></div><h2 id=ログインに失敗する2>ログインに失敗する2</h2><p>IdP のエンドポイントURLに POST-Binding 用が無い場合 (HTTP-Redirectのみなど) には以下のエラーが記録されます。POST-Binding を IdP が処理できるよう設定した上で IdP メタデータを再発行し　TableauServer へ取り込んでください。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-2 : DEBUG com.tableausoftware.saml.SAMLExtendedContextProvider - SAML request parsed as scheme=foo, serverName=hogehoge, serverPort=foo, contextPath=/wg, requestURI=/wg/saml, requestURL=http://hogehoge/wg/saml, isSecure=foo
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-2 : DEBUG org.springframework.security.saml.context.SAMLContextProviderImpl - No IDP specified, using default https://idp.hoge.co.jp
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-2 : DEBUG com.tableausoftware.core.util.ApplicationContextHolder - Retrieving bean class com.tableausoftware.core.configuration.ConfigurationSupportService for bean type class com.tableausoftware.core.configuration.ConfigurationSupportService
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-2 : DEBUG com.tableausoftware.saml.SAMLExtendedEntryPoint - Adding relay state to request, relaystate: [dest=%2F&amp;sendPodInfo=false&amp;authSetting=&amp;siteLuid=&amp;embedded=false]
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-2 : DEBUG org.springframework.security.saml.util.SAMLUtil - Index for AssertionConsumerService not specified, returning default
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-2 : DEBUG org.springframework.security.saml.SAMLEntryPoint - Processing SSO using WebSSO profile
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-2 : DEBUG org.springframework.security.saml.SAMLEntryPoint - Error initializing entry point
</span></span><span class=line><span class=cl>org.opensaml.saml2.metadata.provider.MetadataProviderException: User specified binding urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST is not supported by the IDP using profile urn:oasis:names:tc:SAML:2.0:profiles:SSO:browser
</span></span><span class=line><span class=cl>	at org.springframework.security.saml.websso.WebSSOProfileImpl.getSingleSignOnService(WebSSOProfileImpl.java:147)
</span></span><span class=line><span class=cl>	at org.springframework.security.saml.websso.WebSSOProfileImpl.sendAuthenticationRequest(WebSSOProfileImpl.java:87)
</span></span><span class=line><span class=cl>	at org.springframework.security.saml.SAMLEntryPoint.initializeSSO(SAMLEntryPoint.java:226)
</span></span><span class=line><span class=cl>	at org.springframework.security.saml.SAMLEntryPoint.commence(SAMLEntryPoint.java:153)
</span></span><span class=line><span class=cl>    ...
</span></span></code></pre></div><h2 id=ログインに失敗する3>ログインに失敗する3</h2><p>IdP/SP 間で設定に不整合がある場合には以下のエラーが記録されます。IdP/SP の設定を再確認してください。著者の場合、エンティティIDが不一致の際に出力されていました。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-3 : DEBUG com.tableausoftware.saml.SAMLExtendedContextProvider - SAML request parsed as scheme=https, serverName=hogehoge, serverPort=foo, contextPath=/wg, requestURI=/wg/saml/SSO/index.html, requestURL=https://hogehoge/wg/saml/SSO/index.html, isSecure=true
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-3 : DEBUG org.springframework.security.saml.processor.SAMLProcessorImpl - Retrieving message using binding urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-3 : DEBUG org.springframework.security.saml.util.SAMLUtil - Found endpoint org.opensaml.saml2.metadata.impl.AssertionConsumerServiceImpl@abcdefg for request URL https://hogehoge/wg/saml/SSO/index.html based on location attribute in metadata
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-3 : DEBUG com.tableausoftware.saml.SamlWebSSOProfileConsumer - Verifying issuer of the Response
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-3 : DEBUG com.tableausoftware.saml.SamlWebSSOProfileConsumer - Verifying signature
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-3 : DEBUG org.springframework.security.saml.trust.MetadataCredentialResolver - Added 1 credentials resolved from metadata of entity https://idp.hoge.co.jp
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-3 : DEBUG com.tableausoftware.saml.SamlWebSSOProfileConsumer - Processing Bearer subject confirmation
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-3 : DEBUG com.tableausoftware.saml.SamlWebSSOProfileConsumer - Intended destination https://hogehoge/wg/saml/SSO/index.html matches the endpoint URLhttps://hogehoge/wg/saml/SSO/index.html
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-3 : DEBUG com.tableausoftware.saml.SamlWebSSOProfileConsumer - Validation of authentication statement in assertion failed, skipping
</span></span><span class=line><span class=cl>org.opensaml.common.SAMLException: Our entity is not the intended audience of the assertion
</span></span><span class=line><span class=cl>	at com.tableausoftware.saml.SamlWebSSOProfileConsumer.verifyAudience(SamlWebSSOProfileConsumer.java:161)
</span></span><span class=line><span class=cl>	at com.tableausoftware.saml.SamlWebSSOProfileConsumer.verifyAssertionConditions(SamlWebSSOProfileConsumer.java:117)
</span></span><span class=line><span class=cl>	at org.springframework.security.saml.websso.WebSSOProfileConsumerImpl.verifyAssertion(WebSSOProfileConsumerImpl.java:303)
</span></span><span class=line><span class=cl>	at org.springframework.security.saml.websso.WebSSOProfileConsumerImpl.processAuthenticationResponse(WebSSOProfileConsumerImpl.java:214)
</span></span><span class=line><span class=cl>    ...
</span></span></code></pre></div><h2 id=ログアウトが成功しない>ログアウトが成功しない</h2><p>IdP のシングルログアウト用のエンドポイントURLに POST-Binding 用が無い場合 (HTTP-Redirectのみなど) には以下のエラーが記録されます。シングルログアウト用のエンドポイントURLをIdP側に設定し、IdPメタデータ再発行と TableauServer への取込みを行ってください。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-2 : DEBUG com.tableausoftware.core.util.ApplicationContextHolder - Retrieving bean class org.springframework.security.saml.metadata.CachingMetadataManager for bean type class org.springframework.security.saml.metadata.MetadataManager
</span></span><span class=line><span class=cl>2019-01-23 01:23:45.678 +0000 (,,,,) catalina-exec-2 : ERROR com.tableausoftware.saml.SecurityContextPopulatingFilter - Unable to get the SAMLCredential. Proceeding without populating the SecurityContext.
</span></span><span class=line><span class=cl>java.lang.UnsupportedOperationException: The IDP and SP metadata files do not support a common single logout binding. IDP bindings: . SP bindings: urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST.
</span></span><span class=line><span class=cl>	at com.tableausoftware.saml.SAMLUtils.getServerLevelDefaultIdpLogoutBinding(SAMLUtils.java:73)
</span></span><span class=line><span class=cl>	at com.tableausoftware.saml.SecurityContextPopulatingFilter.doFilter(SecurityContextPopulatingFilter.java:54)
</span></span><span class=line><span class=cl>	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
</span></span><span class=line><span class=cl>	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:192)
</span></span><span class=line><span class=cl>    ...
</span></span></code></pre></div><h2 id=アプリからのログインが完了しない>アプリからのログインが完了しない</h2><p>アプリのログイン画面に TableauServer のトップページが表示されるのみで、認証が正常に完了しないことがあります。これはIdP が SP から渡された RelayState を認証成功時に送り返さない場合に発生します。その場合には IdP を RelayState が正しく扱われるよう設定してください。</p><h1 id=参考資料>参考資料</h1><ol><li>Tableau Server SAML要件<br><a href=https://onlinehelp.tableau.com/current/server/ja-jp/saml_requ.htm>https://onlinehelp.tableau.com/current/server/ja-jp/saml_requ.htm</a></li><li>チュートリアル: Azure Active Directory と Tableau Server の統合<br><a href=https://docs.microsoft.com/ja-jp/azure/active-directory/saas-apps/tableauserver-tutorial>https://docs.microsoft.com/ja-jp/azure/active-directory/saas-apps/tableauserver-tutorial</a></li><li>Security Assertion Markup Language (SAML) V2.0 Technical Overview<br><a href=http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-tech-overview-2.0-cd-02.html>http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-tech-overview-2.0-cd-02.html</a></li><li>SAML Wiki<br><a href=https://wiki.oasis-open.org/security/FrontPage>https://wiki.oasis-open.org/security/FrontPage</a></li></ol></section></article></main></div><div><footer id=site-footer class=toplevel-container><p>このサイトでは <a href=https://icons8.jp/>icons8</a> の素材を使用しています。</p><p>&copy; 2024 namoshika, All rights reserved</p></footer></div></div></body></html>