<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="ノートブック
セル
ノートブック内でコードを実行できる。実行はセル単位で行われ、既定では Python として解釈される。これはマジックコマンドを用いることで他言語として実行することも可能。"><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><meta name=generator content="Hugo 0.147.7"><title>Databricks 製品を使ってみる | Memo.Namo</title><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/style/main.css></head><body><div class=flexbox><div><header id=site-header class=toplevel-container><h1><a href=/>Memo.Namo</a></h1><nav><ul class=horizontal-menu><li class=horizontal-menu-item><a href=/about/>About</a></li><li class=horizontal-menu-item><a href=/knowledge/>Knowledge</a></li></ul></nav></header><main id=site-main class=toplevel-container><article class="content-container content-grid"><header class=content-grid-header><div><a class=nav-category href=/knowledge/databricks/>Databricks</a><h1 class=content-grid-title>Databricks 製品を使ってみる</h1></div><p class=content-grid-desc><span>公開日: 2023-10-23</span>
<span>更新日: 2024-04-26</span></p></header><aside class=content-grid-side><div class=nav-sticky><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ノートブック>ノートブック</a><ul><li><a href=#セル>セル</a></li><li><a href=#マジックコマンド>マジックコマンド</a></li><li><a href=#アウトプット>アウトプット</a></li><li><a href=#パラメータ>パラメータ</a></li></ul></li><li><a href=#ストレージ>ストレージ</a><ul><li><a href=#dbfs>DBFS</a></li><li><a href=#unity-catalog>Unity Catalog</a></li><li><a href=#delta-lake>Delta Lake</a></li></ul></li><li><a href=#etl>ETL</a><ul><li><a href=#メダリオンアーキテクチャ>メダリオンアーキテクチャ</a></li><li><a href=#データ取り込み>データ取り込み</a></li><li><a href=#auto-loader>Auto Loader</a></li><li><a href=#delta-live-tables>Delta Live Tables</a></li><li><a href=#データ品質チェック>データ品質チェック</a></li><li><a href=#job>Job</a></li></ul></li><li><a href=#データ可視化>データ可視化</a></li><li><a href=#権限モデル>権限モデル</a></li><li><a href=#その他>その他</a><ul><li><a href=#テーブルプロパティ>テーブルプロパティ</a></li></ul></li></ul></nav><nav class=nav-tag><h2>タグ</h2><ul class=tag-container><li class="tag-item tag-item-inactive"><a href=/tags/auth/>Auth</a></li><li class="tag-item tag-item-inactive"><a href=/tags/businessman/>BusinessMan</a></li><li class="tag-item tag-item-active"><a href=/tags/database/>Database</a></li><li class="tag-item tag-item-active"><a href=/tags/dataengineering/>DataEngineering</a></li><li class="tag-item tag-item-inactive"><a href=/tags/datavisualization/>DataVisualization</a></li><li class="tag-item tag-item-inactive"><a href=/tags/devops/>DevOps</a></li><li class="tag-item tag-item-inactive"><a href=/tags/iac/>IaC</a></li><li class="tag-item tag-item-inactive"><a href=/tags/infrastructure/>Infrastructure</a></li></ul></nav></div></aside><section class="md-content content-grid-main"><h1 id=ノートブック>ノートブック</h1><h2 id=セル>セル</h2><p>ノートブック内でコードを実行できる。実行はセル単位で行われ、既定では Python として解釈される。これはマジックコマンドを用いることで他言語として実行することも可能。</p><p><img src=image/databricks-notebook-cell.png alt></p><h2 id=マジックコマンド>マジックコマンド</h2><p>セル先頭に特定のキーワードを入れるとセルの動作モードが変化する。その他、様々なコマンドも使用可能。</p><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td>%python</td><td>セル内を Python として実行する</td></tr><tr><td>%sql</td><td>セル内を SQL として実行する</td></tr><tr><td>%run</td><td>指定したノートブックを実行する</td></tr><tr><td>%fs</td><td>DBFS (後述) の中を照会</td></tr><tr><td>%sh</td><td>クラスターのドライバー内でシェルコマンドを実行する</td></tr><tr><td>%pip</td><td>クラスターの全ノードで pip コマンドを実行する</td></tr></tbody></table><p><img src=image/databricks-notebook-magic.png alt></p><h2 id=アウトプット>アウトプット</h2><p>display を用いると DataFrame を表形式で描画できる。操作することでグラフなども作れる。</p><p><img src=image/databricks-notebook-display.png alt></p><h2 id=パラメータ>パラメータ</h2><p>外部からパラメータとして値を入力可能。型は文字列のみ。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># python 版</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dbutils</span><span class=o>.</span><span class=n>widgets</span><span class=o>.</span><span class=n>text</span><span class=p>(</span><span class=s2>&#34;hoge&#34;</span><span class=p>,</span> <span class=s2>&#34;sample text&#34;</span><span class=p>,</span> <span class=s2>&#34;hoge_label&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dbutils</span><span class=o>.</span><span class=n>widgets</span><span class=o>.</span><span class=n>dropdown</span><span class=p>(</span><span class=s2>&#34;fooo&#34;</span><span class=p>,</span> <span class=s2>&#34;val1&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;val1&#34;</span><span class=p>,</span> <span class=s2>&#34;val2&#34;</span><span class=p>,</span> <span class=s2>&#34;val3&#34;</span><span class=p>],</span> <span class=s2>&#34;fooo_label&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hoge</span> <span class=o>=</span> <span class=n>dbutils</span><span class=o>.</span><span class=n>widgets</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;hoge&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fooo</span> <span class=o>=</span> <span class=n>dbutils</span><span class=o>.</span><span class=n>widgets</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;fooo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>hoge</span><span class=p>,</span> <span class=n>fooo</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- SQL 版
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=n>WIDGET</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=o>`</span><span class=n>hoge</span><span class=o>`</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=s2>&#34;sample text&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=n>WIDGET</span><span class=w> </span><span class=n>DROPDOWN</span><span class=w> </span><span class=o>`</span><span class=n>fooo</span><span class=o>`</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=s2>&#34;val1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>CHOICES</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;val1&#34;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;val2&#34;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;val3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;${hoge}&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;${fooo}&#34;</span><span class=w>
</span></span></span></code></pre></div><h1 id=ストレージ>ストレージ</h1><h2 id=dbfs>DBFS</h2><p>ストレージにはローカルとDBFSがある。
DBFSを挟むことで S3 を始めとするオブジェクトストレージへの読み書きを抽象化する。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># ローカルファイルシステム</span>
</span></span><span class=line><span class=cl><span class=o>%</span><span class=n>fs</span> <span class=n>ls</span> <span class=n>file</span><span class=p>:</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=n>dbutils</span><span class=o>.</span><span class=n>fs</span><span class=o>.</span><span class=n>ls</span><span class=p>(</span><span class=s2>&#34;file:/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># DBFS (スキーマ未指定時にはDBFSが参照される)</span>
</span></span><span class=line><span class=cl><span class=o>%</span><span class=n>fs</span> <span class=n>ls</span> <span class=n>dbfs</span><span class=p>:</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=o>%</span><span class=n>fs</span> <span class=n>ls</span> <span class=o>/</span>
</span></span><span class=line><span class=cl><span class=n>dbutils</span><span class=o>.</span><span class=n>fs</span><span class=o>.</span><span class=n>ls</span><span class=p>(</span><span class=s2>&#34;dbfs:/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ローカルに対してシェルスクリプト</span>
</span></span><span class=line><span class=cl><span class=o>%</span><span class=n>sh</span> <span class=n>ls</span> <span class=o>-</span><span class=n>Al</span> <span class=o>/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># DBFS の中でファイルをコピー</span>
</span></span><span class=line><span class=cl><span class=c1># /FileStore へ保存するとブラウザからアクセス可能</span>
</span></span><span class=line><span class=cl><span class=n>dbutils</span><span class=o>.</span><span class=n>fs</span><span class=o>.</span><span class=n>cp</span><span class=p>(</span><span class=s2>&#34;/databricks-datasets/README.md&#34;</span><span class=p>,</span> <span class=s2>&#34;/FileStore/README.md&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>displayHTML</span><span class=p>(</span><span class=s2>&#34;&lt;a href=&#39;files/README.md/&#39;&gt;aaa&lt;/a&gt;&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=unity-catalog>Unity Catalog</h2><p>ワークスペースを跨いだ権限管理を行いたい場合には Unity Catalog が使える。
これを用いる場合はデータへのアクセスが3階層になる。カタログというが他DBMSにおけるデータベースに該当すると言える。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- カタログやスキーマを定義
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>CATALOG</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>mycatalog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>myschema</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>mycatalog</span><span class=p>.</span><span class=n>myschema</span><span class=p>.</span><span class=n>mytable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 既定のカタログやスキーマを変更する場合は以下の通り
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>USE</span><span class=w> </span><span class=k>CATALOG</span><span class=w> </span><span class=n>mycatalog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>USE</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=n>myschema</span><span class=w>
</span></span></span></code></pre></div><h2 id=delta-lake>Delta Lake</h2><p>Databricks は Delta を推している。このフォーマットはデータ保存へ Parquet 形式を使いつつ、メタデータ管理などを追加することで ACID トランザクションやデータのバージョニングなど高度な機能を実現している。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>write</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;delta&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>savePath</span><span class=p>)</span>
</span></span></code></pre></div><h1 id=etl>ETL</h1><h2 id=メダリオンアーキテクチャ>メダリオンアーキテクチャ</h2><p>Databricks では ETL パイプラインの構造として以下のレイヤードアーキテクチャを推奨している。</p><ul><li>Bronze: 未処理の生データ</li><li>Silver: クレンジング済みデータ. 正規化済み</li><li>Gold: BI ツールで読み込める水準まで処理されたデータ</li></ul><p><img src=image/databricks-etl-medal.png alt>
引用元: <a href=https://www.databricks.com/jp/glossary/medallion-architecture>https://www.databricks.com/jp/glossary/medallion-architecture</a></p><h2 id=データ取り込み>データ取り込み</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- SQL のテーブル定義で制約を指定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>customers_from_into</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>customer_id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>tax_id</span><span class=w> </span><span class=n>DOUBLE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>tax_code</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>customer_name</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>state</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>city</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>postcode</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>street</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nb>number</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>unit</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>region</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>district</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>lon</span><span class=w> </span><span class=n>DOUBLE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>lat</span><span class=w> </span><span class=n>DOUBLE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>ship_to_address</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>valid_from</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>valid_to</span><span class=w> </span><span class=n>DOUBLE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>units_purchased</span><span class=w> </span><span class=n>DOUBLE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>loyalty_segment</span><span class=w> </span><span class=nb>INTEGER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- データロード
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>COPY</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>customers_from_into</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;/databricks-datasets/retail-org/customers/&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>FILEFORMAT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>csv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>VALIDATE</span><span class=w> </span><span class=c1>-- このキーワードを付けると検証のみで実際のロードは行わない
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>FORMAT_OPTIONS</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;header&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;inferSchema&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h2 id=auto-loader>Auto Loader</h2><p>クラウドストレージを参照する場合は Auto Loader を使うと新着ファイルを効率的に処理できる (使用する場合は format に cloudFiles を指定)。内部では構造化ストリーミング処理が用いられており、spark.readStream というワードからも見て取れる。</p><p>python 版</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># 参考: https://docs.databricks.com/ja/ingestion/auto-loader/index.html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>readStream</span> \
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;cloudfiles&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;encoding&#34;</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;cloudfiles.format&#34;</span><span class=p>,</span> <span class=s2>&#34;csv&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;cloudfiles.schemaLocation&#34;</span><span class=p>,</span> <span class=s2>&#34;/tmp/checkpoints/customers&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;cloudFiles.schemaHints&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;customer_id Integer, tax_id Double, tax_code String, customer_name String, state String, city String, postcode String, street String, number String, unit String, region String, district String, lon Double, lat Double, ship_to_address String, valid_from Integer, valid_to Double, units_purchased Double, loyalty_segment Integer&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> \
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;/databricks-datasets/retail-org/customers/&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span></code></pre></div><p>SQL 版</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 参考: https://docs.databricks.com/ja/sql/language-manual/functions/read_files.html#usage-in-streaming-tables
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>STREAM</span><span class=w> </span><span class=n>read_files</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s1>&#39;/databricks-datasets/retail-org/customers/&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>format</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;csv&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>encoding</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;utf8&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>header</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>schemaLocation</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s2>&#34;/tmp/checkpoints/customers&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>schemaHints</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s2>&#34;customer_id Integer, tax_id Double, tax_code String, customer_name String, state String, city String, postcode String, street String, number String, unit String, region String, district String, lon Double, lat Double, ship_to_address String, valid_from Integer, valid_to Double, units_purchased Double, loyalty_segment Integer&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h2 id=delta-live-tables>Delta Live Tables</h2><p>ETL パイプラインを簡単に構築する仕組み。宣言的にテーブルやビューを定義する事で依存関係からパイプラインを構築できる。宣言されたテーブルはパイプライン内のみで参照可能。外部からも参照したい場合はパイプラインを構成する際にターゲットスキーマを指定する。テーブルは実際にはマテリアライズド・ビューとして扱われる。</p><p>いくつか制約がある。</p><ul><li>Python で定義する場合は構文チェックはされない</li><li><code>%pip</code> 以外のマジックコマンドは使用不可 &mldr; 使ったセルは実行がスキップされる</li><li>ロード先を Unity Catalog にしていると共有コンピュートクラスターからのみ参照可能<br>(<a href=https://docs.databricks.com/ja/sql/user/materialized-views.html>Databricks SQLでのマテリアライズドビューの使用</a>)<blockquote><p>Databricks SQL 具体化されたビューは、Databricks SQLウェアハウス、Delta Live Tables、および Databricks Runtime 11.3 以降を実行している共有クラスターからのみクエリできます。</p></blockquote></li></ul><p>Python 版</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dlt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通常テーブルを定義</span>
</span></span><span class=line><span class=cl><span class=nd>@dlt.table</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sample_tbl_py1</span><span class=p>():</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;csv&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;header&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;inferSchema&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;/databricks-datasets/retail-org/customers/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通常テーブルを定義 (パイプライン内のを参照)</span>
</span></span><span class=line><span class=cl><span class=nd>@dlt.table</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sample_tbl_py2</span><span class=p>():</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>spark</span><span class=o>.</span><span class=n>table</span><span class=p>(</span><span class=s2>&#34;LIVE.sample_tbl_py1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通常テーブルを定義 (Auto Loader)</span>
</span></span><span class=line><span class=cl><span class=c1># DLT で Auto Loader を使う場合はDLT 側で設定されるため schemaLocation 不要</span>
</span></span><span class=line><span class=cl><span class=c1># (参考: https://docs.databricks.com/ja/ingestion/auto-loader/schema.html#syntax-for-schema-inference-and-evolution)</span>
</span></span><span class=line><span class=cl><span class=nd>@dlt.table</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sample_tbl_py3</span><span class=p>():</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>spark</span><span class=o>.</span><span class=n>readStream</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;cloudFiles&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;header&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;cloudFiles.format&#34;</span><span class=p>,</span> <span class=s2>&#34;csv&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;cloudFiles.inferColumnTypes&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;cloudFiles.schemaHints&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;customer_id Integer, tax_id Double, tax_code String, customer_name String, state String, city String, postcode String, street String, number String, unit String, region String, district String, lon Double, lat Double, ship_to_address String, valid_from Integer, valid_to Double, units_purchased Double, loyalty_segment Integer&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> \
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;/databricks-datasets/retail-org/customers/&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>SQL 版</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 通常テーブルを定義
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>REFRESH</span><span class=w> </span><span class=n>LIVE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl_sql1</span><span class=w> </span><span class=k>AS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>read_files</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s1>&#39;/databricks-datasets/retail-org/customers/&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>format</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;csv&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>header</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>inferSchema</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 通常テーブルを定義 (パイプライン内のを参照)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>REFRESH</span><span class=w> </span><span class=n>LIVE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl_sql2</span><span class=w> </span><span class=k>AS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>LIVE</span><span class=p>.</span><span class=n>sample_tbl_sql1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 通常テーブルを定義 (Auto Loader)
</span></span></span><span class=line><span class=cl><span class=c1>-- DLT で Auto Loader を使う場合はDLT 側で設定されるため schemaLocation 不要
</span></span></span><span class=line><span class=cl><span class=c1>-- (参考: https://docs.databricks.com/ja/ingestion/auto-loader/schema.html#syntax-for-schema-inference-and-evolution)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>REFRESH</span><span class=w> </span><span class=n>STREAMING</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl_sql3</span><span class=w> </span><span class=k>AS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>STREAM</span><span class=w> </span><span class=n>read_files</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s1>&#39;/databricks-datasets/retail-org/customers/&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>format</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;csv&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>header</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>inferColumnTypes</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>schemaHints</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s2>&#34;customer_id Integer, tax_id Double, tax_code String, customer_name String, state String, city String, postcode String, street String, number String, unit String, region String, district String, lon Double, lat Double, ship_to_address String, valid_from Integer, valid_to Double, units_purchased Double, loyalty_segment Integer&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Delta Live Table には CDC を扱うための仕組みもある。扱う際には <code>apply_changes</code> や <code>APPLY CHANGE INTO</code> を使う (<a href=https://docs.databricks.com/ja/delta-live-tables/cdc.html>https://docs.databricks.com/ja/delta-live-tables/cdc.html</a>)。</p><p>Python 版</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dlt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dlt.table</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sample_cdc_py4</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>spark</span><span class=o>.</span><span class=n>createDataFrame</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s2>&#34;hoge_0&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;hoge_1&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;hoge_2&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;hoge_1_updated&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;seq integer, id integer, val string&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dlt</span><span class=o>.</span><span class=n>create_streaming_table</span><span class=p>(</span><span class=s2>&#34;sample_tbl_py4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dlt</span><span class=o>.</span><span class=n>apply_changes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span> <span class=o>=</span> <span class=s2>&#34;sample_tbl_py4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>source</span> <span class=o>=</span> <span class=s2>&#34;sample_cdc_py4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>keys</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=n>sequence_by</span> <span class=o>=</span> <span class=s2>&#34;seq&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>except_column_list</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;seq&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=n>stored_as_scd_type</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>SQL 版</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- CDCテーブルを作成
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>REFRESH</span><span class=w> </span><span class=k>TEMPORARY</span><span class=w> </span><span class=n>LIVE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_cdc_sql4</span><span class=w> </span><span class=k>AS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- ここではインラインでレコードを書いているためフルリフレッシュのみ正常終了が可能
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;hoge_0&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;hoge_1&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;hoge_2&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;hoge_1_updated&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>val</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 更新先テーブルを作成
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>REFRESH</span><span class=w> </span><span class=n>STREAMING</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl_sql4</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=n>STRING</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- CDC を更新先テーブルへ反映
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>APPLY</span><span class=w> </span><span class=n>CHANGES</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>LIVE</span><span class=p>.</span><span class=n>sample_tbl_sql4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>STREAM</span><span class=w> </span><span class=n>LIVE</span><span class=p>.</span><span class=n>sample_cdc_sql4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>KEYS</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>SEQUENCE</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>seq</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>COLUMNS</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>EXCEPT</span><span class=w> </span><span class=p>(</span><span class=n>seq</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>STORED</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>SCD</span><span class=w> </span><span class=k>TYPE</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=データ品質チェック>データ品質チェック</h2><p>Delta Live Table ではパイプライン内でデータの検証が可能。SQL 版を記載するが Python もできるはず。
(<a href=https://docs.databricks.com/ja/delta-live-tables/expectations.html>https://docs.databricks.com/ja/delta-live-tables/expectations.html</a>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>REFRESH</span><span class=w> </span><span class=n>LIVE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl_sql5</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>-- 不正行は取り込まない
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=k>CONSTRAINT</span><span class=w> </span><span class=n>cons_customer_id</span><span class=w> </span><span class=n>EXPECT</span><span class=w> </span><span class=p>(</span><span class=n>customer_id</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>VIOLATION</span><span class=w> </span><span class=k>DROP</span><span class=w> </span><span class=k>ROW</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>-- 不正行が有ればロード処理自体を失敗させる
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=k>CONSTRAINT</span><span class=w> </span><span class=n>cons_customer_name</span><span class=w> </span><span class=n>EXPECT</span><span class=w> </span><span class=p>(</span><span class=n>customer_name</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>VIOLATION</span><span class=w> </span><span class=n>FAIL</span><span class=w> </span><span class=k>UPDATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>-- ON VIOLATION ～ を省略すれば取り込まれた上で
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=c1>-- パイプライン上でのメトリクスから不正行の件数を確認できる
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>LIVE</span><span class=p>.</span><span class=n>sample_tbl_sql2</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;IN&#39;</span><span class=w>
</span></span></span></code></pre></div><h2 id=job>Job</h2><p>使い道</p><ul><li>ワークフロー実行 (トリガーとして定期起動とファイル到着の監視が可能)</li><li>Delta Live Table のロード処理</li></ul><h1 id=データ可視化>データ可視化</h1><h1 id=権限モデル>権限モデル</h1><p>Unity Catalog を用いた権限管理ができ、これはワークスペースを跨いで適用される。</p><p>権限管理には明示的なアクセス許可モデルが採用されており、親オブジェクトからの権限継承は無く、
データへアクセスする際にはテーブル、スキーマ、カタログのそれぞれに対する USAGE 許可を要する。
アクセス制御を行うプリンシパルは Databricks のアカウント管理画面からユーザやグループを登録可能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>GRANT</span><span class=w> </span><span class=k>USAGE</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>CATALOG</span><span class=w> </span><span class=n>mycatalog</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=o>`</span><span class=n>account</span><span class=w> </span><span class=n>users</span><span class=o>`</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GRANT</span><span class=w> </span><span class=k>USAGE</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=n>myschema</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=o>`</span><span class=n>account</span><span class=w> </span><span class=n>users</span><span class=o>`</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- ビューを通してテーブルへアクセスした場合、
</span></span></span><span class=line><span class=cl><span class=c1>-- テーブルへのアクセスはビュー作成者として行われる
</span></span></span><span class=line><span class=cl><span class=c1>-- User -&gt; View (ユーザとしてアクセス) -&gt; Table (ビュー作成者としてアクセス)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>GRANT</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>myview</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=o>`</span><span class=n>account</span><span class=w> </span><span class=n>users</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>REVOKE</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>myview</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>account</span><span class=w> </span><span class=n>users</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 付与された権限を表示
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SHOW</span><span class=w> </span><span class=k>GRANT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>table_name</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>テーブルの列や行単位で保護する (ダイナミックビュー) 事も可能。各種メソッドと条件式を組み合わせて作る。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>current_user</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>is_account_group_member</span><span class=p>(</span><span class=n>group_name</span><span class=w> </span><span class=n>STRING</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h1 id=その他>その他</h1><h2 id=テーブルプロパティ>テーブルプロパティ</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- CREATE OR REPLACE TABLE sample_tbl(col_a INTEGER, col_b INTEGER) OPTIONS (prop_1=123, prop_2=234);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sample_tbl</span><span class=p>(</span><span class=n>col_a</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w> </span><span class=n>col_b</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>)</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;コメント&#39;</span><span class=w> </span><span class=n>TBLPROPERTIES</span><span class=w> </span><span class=p>(</span><span class=n>prop_1</span><span class=o>=</span><span class=mi>123</span><span class=p>,</span><span class=w> </span><span class=n>prop_2</span><span class=o>=</span><span class=mi>234</span><span class=p>,</span><span class=w> </span><span class=n>layer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;bronze&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=n>TBLPROPERTIES</span><span class=w> </span><span class=n>sample_tbl</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>テーブルプロパティを取得するサンプルコード</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyspark.sql.functions</span> <span class=k>as</span> <span class=nn>F</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_layer_name</span><span class=p>(</span><span class=n>database</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>tableName</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SHOW TBLPROPERTIES </span><span class=si>{</span><span class=n>database</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>tableName</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>&#34;key&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;layer&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&#34;value&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>res</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s2>&#34;value&#34;</span><span class=p>]</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>res</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># テーブル一覧を取得</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=p>(</span><span class=s2>&#34;SHOW TABLES FROM default&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&#34;database&#34;</span><span class=p>,</span> <span class=s2>&#34;tableName&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>toPandas</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># レイヤー情報を付与</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s2>&#34;layer&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>get_layer_name</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&#34;database&#34;</span><span class=p>],</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;tableName&#34;</span><span class=p>]),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Spark DataFrame へ変換</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>createDataFrame</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>display</span><span class=p>()</span>
</span></span></code></pre></div></section></article></main></div><div><footer id=site-footer class=toplevel-container><p>このサイトでは <a href=https://icons8.jp/>icons8</a> の素材を使用しています。</p><p>&copy; 2025 namoshika, All rights reserved</p></footer></div></div></body></html>